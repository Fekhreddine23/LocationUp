<!-- booking-management.html -->
<div class="booking-management-container">
  <app-breadcrumbs [items]="breadcrumbItems"></app-breadcrumbs>

  <div class="page-header">
    <div class="header-content">
      <h1>Gestion des R√©servations</h1>
      <p>Supervisez et g√©z toutes les r√©servations du syst√®me</p>
    </div>
    <button (click)="goBackToDashboard()" class="back-btn">
      ‚Üê Retour au Dashboard
    </button>
  </div>

  <!-- Messages -->
  <div *ngIf="successMessage" class="alert alert-success">
    ‚úÖ {{ successMessage }}
  </div>
  <div *ngIf="errorMessage" class="alert alert-error">
    ‚ùå {{ errorMessage }}
  </div>

  <!-- Statistiques -->
  <ng-container *ngIf="!statsLoading; else statsSkeleton">
    <div class="stats-section card-surface">
      <div class="stats-grid">
        <div class="stat-card accent-primary">
          <div class="stat-icon">üí∂</div>
          <div class="stat-content">
            <div class="stat-number">{{ formatCurrency(bookingStats.totalRevenue) }}</div>
            <div class="stat-label">Revenus Totaux</div>
          </div>
        </div>
        <div class="stat-card accent-success">
          <div class="stat-icon">üìà</div>
          <div class="stat-content">
            <div class="stat-number">{{ formatCurrency(bookingStats.monthToDateRevenue) }}</div>
            <div class="stat-label">Revenus du Mois</div>
          </div>
        </div>
        <div class="stat-card accent-warning">
          <div class="stat-icon">üïí</div>
          <div class="stat-content">
            <div class="stat-number">{{ formatCurrency(bookingStats.outstandingRevenue) }}</div>
            <div class="stat-label">En Attente</div>
          </div>
        </div>
        <div class="stat-card accent-info">
          <div class="stat-icon">‚öñÔ∏è</div>
          <div class="stat-content">
            <div class="stat-number">{{ formatPercentage(bookingStats.confirmationRate) }}</div>
            <div class="stat-label">Taux de Confirmation</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üìä</div>
          <div class="stat-content">
            <div class="stat-number">{{ bookingStats.totalBookings }}</div>
            <div class="stat-label">Total R√©servations</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">‚è≥</div>
          <div class="stat-content">
            <div class="stat-number">{{ bookingStats.pendingBookings }}</div>
            <div class="stat-label">En Attente</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">‚úÖ</div>
          <div class="stat-content">
            <div class="stat-number">{{ bookingStats.confirmedBookings }}</div>
            <div class="stat-label">Confirm√©es</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üèÅ</div>
          <div class="stat-content">
            <div class="stat-number">{{ bookingStats.completedBookings }}</div>
            <div class="stat-label">Termin√©es</div>
          </div>
        </div>
      </div>
    </div>
  </ng-container>

  <ng-template #statsSkeleton>
    <div class="stats-section stats-skeleton card-surface" aria-live="polite">
      <div class="stats-grid">
        <div class="stat-card skeleton" *ngFor="let _ of statSkeletonCards">
          <div class="stat-icon"></div>
          <div class="stat-content">
            <div class="skeleton-line"></div>
            <div class="skeleton-line short"></div>
          </div>
        </div>
      </div>
    </div>
  </ng-template>

  <!-- Section alertes / anomalies -->
  <section class="action-alerts-panel card-surface" [class.loading-state]="actionAlertsLoading">
    <div class="panel-header">
      <div>
        <h3>Alertes paiement / Action requise</h3>
        <p>{{ actionAlerts.length }} dossiers √† surveiller</p>
      </div>
      <div class="panel-actions">
        <button type="button" class="ghost-btn" (click)="refreshActionAlerts()">‚Üª Actualiser</button>
        <button type="button" class="primary-btn" (click)="downloadActionAlertsCsv()">‚¨áÔ∏è Export</button>
      </div>
    </div>
    <div class="action-alerts-filters">
      <div class="severity-toggle">
        <button type="button" [class.active]="actionAlertSeverity === 'ALL'" (click)="setActionAlertSeverity('ALL')">Toutes</button>
        <button type="button" [class.active]="actionAlertSeverity === 'ALERTE'" (click)="setActionAlertSeverity('ALERTE')">Alertes</button>
        <button type="button" [class.active]="actionAlertSeverity === 'CRITIQUE'" (click)="setActionAlertSeverity('CRITIQUE')">Critiques</button>
      </div>
      <div class="status-chips">
        <button type="button"
                *ngFor="let status of ['PENDING','REQUIRES_ACTION','FAILED','EXPIRED']"
                [class.active]="actionAlertStatuses[status]"
                (click)="toggleActionAlertStatus(status)">
          {{ status }}
        </button>
      </div>
      <div class="alert-search">
        <input type="search" [(ngModel)]="actionAlertSearch" placeholder="Recherche (client, message...)" (keyup.enter)="applyActionAlertSearch()">
        <button type="button" class="ghost-btn" (click)="applyActionAlertSearch()">Filtrer</button>
        <button type="button" class="ghost-btn" (click)="resetActionAlertFilters()">R√©initialiser</button>
      </div>
    </div>
    <div class="alerts-list" *ngIf="!actionAlertsLoading && actionAlerts.length > 0; else alertFallback">
      <article class="alert-card" *ngFor="let alert of actionAlerts">
        <div class="alert-badge" [ngClass]="alert.severity.toLowerCase()">
          {{ alert.severity }}
        </div>
        <div class="alert-main">
          <div class="alert-header">
            <span class="alert-id">R√©servation #{{ alert.reservationId }}</span>
            <span class="alert-amount">{{ alert.amount | number:'1.2-2' }} ‚Ç¨</span>
          </div>
          <div class="alert-message">{{ alert.message }}</div>
          <div class="alert-meta">
            <span>Client : <strong>{{ alert.customer }}</strong></span>
            <span>Status : <strong>{{ alert.paymentStatus }}</strong></span>
            <span>{{ alert.reservationDate | date:'dd/MM √† HH:mm' }}</span>
          </div>
        </div>
      </article>
    </div>
    <ng-template #alertFallback>
      <div class="alerts-empty" *ngIf="!actionAlertsLoading && actionAlerts.length === 0">Aucune alerte √† traiter üéâ</div>
      <div class="alerts-loader loading-state" *ngIf="actionAlertsLoading">
        <div class="app-skeleton-line" *ngFor="let _ of actionAlertSkeletons"></div>
      </div>
      <div class="alerts-error" *ngIf="actionAlertError">{{ actionAlertError }}</div>
    </ng-template>
  </section>

  <!-- Barre de recherche et filtres -->
  <div class="filters-section card-surface">
    <div class="search-bar">
      <input 
        type="text" 
        [(ngModel)]="searchQuery" 
        (input)="searchBookings()"
        placeholder="Rechercher une r√©servation, utilisateur..."
        class="search-input">
      <button (click)="searchBookings()" class="search-btn">
        üîç Rechercher
      </button>
    </div>

    <div class="filter-controls">
      <select [(ngModel)]="statusFilter" (change)="applyFilters()" class="filter-select">
        <option value="ALL">Tous les statuts</option>
        <option value="PENDING">En attente</option>
        <option value="CONFIRMED">Confirm√©es</option>
        <option value="CANCELLED">Annul√©es</option>
        <option value="COMPLETED">Termin√©es</option>
      </select>

      <input 
        type="date" 
        [(ngModel)]="dateFilter" 
        (change)="applyFilters()"
        class="filter-input">

      <button (click)="loadBookings()" class="refresh-btn">
        üîÑ Actualiser
      </button>
    </div>
    <div class="filter-actions">
      <label class="anomaly-toggle">
        <input type="checkbox" [(ngModel)]="showAnomaliesOnly" (change)="applyFilters()">
        <span>Afficher uniquement les paiements √† risque</span>
      </label>
      <div class="identity-filter">
        <span>Identit√© :</span>
        <button type="button" [class.active]="identityFilter === 'ALL'" (click)="setIdentityFilter('ALL')">
          Toutes
        </button>
        <button type="button" [class.active]="identityFilter === 'VERIFIED'" (click)="setIdentityFilter('VERIFIED')">
          Valid√©es
        </button>
        <button type="button" [class.active]="identityFilter === 'UNVERIFIED'" (click)="setIdentityFilter('UNVERIFIED')">
          Non v√©rifi√©es
        </button>
      </div>
      <button (click)="downloadBookingsCsv()" class="export-btn">
        ‚¨áÔ∏è Export CSV
      </button>
    </div>
  </div>

  <!-- Filtres actifs -->
  <div class="active-filters" *ngIf="hasActiveFilters()">
    <div class="active-filter" *ngIf="getActiveUserFilter() as userFilter">
      <span class="filter-label">üë§ Utilisateur:</span>
      <span class="filter-value">{{ userFilter.name }}</span>
      <button (click)="clearUserFilter()" class="btn-clear-filter" title="Supprimer le filtre">
        √ó
      </button>
    </div>
    
    <div class="active-filter" *ngIf="statusFilter !== 'ALL'">
      <span class="filter-label">üìä Statut:</span>
      <span class="filter-value">{{ getStatusText(statusFilter) }}</span>
      <button (click)="clearStatusFilter()" class="btn-clear-filter" title="Supprimer le filtre">
        √ó
      </button>
    </div>
    
    <div class="active-filter" *ngIf="dateFilter">
      <span class="filter-label">üìÖ Date:</span>
      <span class="filter-value">{{ formatDisplayDate(dateFilter) }}</span>
      <button (click)="clearDateFilter()" class="btn-clear-filter" title="Supprimer le filtre">
        √ó
      </button>
    </div>
    <div class="active-filter" *ngIf="identityFilter !== 'ALL'">
      <span class="filter-label">ü™™ Identit√©:</span>
      <span class="filter-value">{{ getIdentityFilterLabel() }}</span>
      <button (click)="clearIdentityFilter()" class="btn-clear-filter" title="Supprimer le filtre">
        √ó
      </button>
    </div>

    <div class="active-filter" *ngIf="showAnomaliesOnly">
      <span class="filter-label">‚ö†Ô∏è Anomalies:</span>
      <span class="filter-value">Paiements sous surveillance</span>
      <button (click)="clearAnomalyFilter()" class="btn-clear-filter" title="Supprimer le filtre">
        √ó
      </button>
    </div>
    
    <button *ngIf="hasMultipleFilters()" (click)="clearAllFilters()" class="btn-clear-all">
      üóëÔ∏è Supprimer tous les filtres
    </button>
  </div>

  <!-- Tableau des r√©servations -->
  <div class="bookings-table-container card-surface" [class.is-loading]="isLoading">
    <div class="table-header">
      <div class="table-stats">
        {{ displayedBookingsCount }} r√©servation(s) trouv√©e(s)
      </div>
    </div>

    <div *ngIf="isLoading" class="table-loading-skeleton loading-state" aria-live="polite">
      <div class="skeleton-row" *ngFor="let _ of skeletonRows">
        <span class="app-skeleton-line" *ngFor="let __ of skeletonColumns"></span>
      </div>
    </div>

    <div *ngIf="!isLoading && filteredBookings.length === 0" class="empty-state" aria-live="polite">
      <p>Aucune r√©servation trouv√©e avec ce filtre.</p>
      <button (click)="loadBookings()" class="ghost-btn">‚Üª Actualiser</button>
    </div>

    <div class="responsive-table" *ngIf="!isLoading && filteredBookings.length > 0">
      <table class="bookings-table">
        <thead>
          <tr>
            <th>R√©servation</th>
            <th>Utilisateur</th>
            <th>Service</th>
            <th>Date</th>
            <th>Prix</th>
            <th>Statut</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let booking of filteredBookings" class="booking-row"
              [class.focused-booking]="booking.reservationId === focusedReservationId"
              [attr.id]="'booking-row-' + booking.reservationId">
            <td class="booking-info" [attr.data-label]="'R√©servation'">
              <div class="booking-id">#{{ booking.reservationId }}</div>
              <div class="booking-date">
                Cr√©√©e le {{ formatShortDate(booking.createdAt) }}
              </div>
            </td>
            <td class="user-info" [attr.data-label]="'Utilisateur'">
              <div class="user-avatar">
                {{ booking.user?.username?.charAt(0)?.toUpperCase() || '?' }}
              </div>
              <div class="user-details">
                <strong>{{ booking.user?.username || 'Utilisateur inconnu' }}</strong>
                <span class="user-email">{{ booking.user?.email || 'Email non disponible' }}</span>
                <span class="identity-chip" [ngClass]="getIdentityBadgeClass(booking.identityStatus)">
                  {{ getIdentityLabel(booking.identityStatus) }}
                </span>
              </div>
            </td>
            <td class="service-info" [attr.data-label]="'Service'">
              <div class="service-name">{{ booking.offer?.mobilityService || 'Service inconnu' }}</div>
              <div class="service-location">{{ booking.offer?.pickupLocation || 'Lieu non disponible' }}</div>
            </td>
            <td class="reservation-date" [attr.data-label]="'Date'">
              {{ formatDate(booking.reservationDate) }}
            </td>
            <td class="booking-price" [attr.data-label]="'Prix'">
              {{ formatCurrency(booking.totalPrice ?? booking.offer?.price) }}
            </td>
            <td [attr.data-label]="'Statut'">
              <span [class]="'status-badge ' + getStatusClass(booking.status)">
                {{ getStatusText(booking.status) }}
              </span>
            </td>
            <td class="actions" [attr.data-label]="'Actions'">
              <button (click)="viewBookingDetails(booking)" class="btn-view" title="D√©tails">
                üëÅÔ∏è
              </button>
              <button 
                *ngIf="canConfirm(booking)"
                (click)="confirmBooking(booking)" 
                class="btn-confirm" 
                title="Confirmer">
                ‚úÖ
              </button>
              <button 
                *ngIf="canForceConfirm(booking)"
                (click)="confirmBookingForced(booking)" 
                class="btn-force-confirm" 
                title="Forcer la confirmation sans paiement">
                ‚ö†Ô∏è
              </button>
              <button 
                *ngIf="canCollectPayment(booking)"
                (click)="collectPayment(booking)" 
                class="btn-payment" 
                title="Encaisser via Stripe">
                üí≥
              </button>
              <button
                *ngIf="canForceExpire(booking)"
                (click)="forcePaymentExpiration(booking)"
                class="btn-expire"
                [disabled]="isPaymentActionLoading(booking.reservationId)"
                title="Forcer l'expiration du paiement">
                ‚è≥
              </button>
              <button
                *ngIf="canForceRefund(booking)"
                (click)="forcePaymentRefund(booking)"
                class="btn-refund"
                [disabled]="isPaymentActionLoading(booking.reservationId)"
                title="Rembourser manuellement">
                üí∏
              </button>
              <button 
                *ngIf="canCancel(booking)"
                (click)="cancelBooking(booking)" 
                class="btn-cancel" 
                title="Annuler">
                ‚ùå
              </button>
              <button 
                *ngIf="canComplete(booking)"
                (click)="completeBooking(booking)" 
                class="btn-complete" 
                title="Terminer">
                üèÅ
              </button>
              <button (click)="confirmDelete(booking)" class="btn-delete" title="Supprimer">
                üóëÔ∏è
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div *ngIf="totalPages > 1" class="pagination">
      <button 
        (click)="goToPage(currentPage - 1)" 
        [disabled]="currentPage === 0"
        class="pagination-btn">
        ‚Üê Pr√©c√©dent
      </button>
      
      <span class="pagination-info">
        Page {{ currentPage + 1 }} sur {{ totalPages }}
      </span>
      
      <button 
        (click)="goToPage(currentPage + 1)" 
        [disabled]="currentPage >= totalPages - 1"
        class="pagination-btn">
        Suivant ‚Üí
      </button>
    </div>
  </div>

  <!-- Modal de d√©tails -->
  <div *ngIf="isDetailModalOpen" class="modal-overlay">
    <div class="modal large-modal card-surface" [class.loading-state]="isDetailModalProcessing">
      <div class="modal-loader" *ngIf="isDetailModalProcessing">
        <span class="loader-dot"></span>
        <span>Chargement des donn√©es...</span>
      </div>
      <div class="modal-header">
        <h3>D√©tails de la R√©servation #{{ selectedBooking?.reservationId }}</h3>
        <button (click)="closeDetailModal()" class="close-btn">√ó</button>
      </div>
      <div class="modal-content" *ngIf="selectedBooking">
        <div class="detail-loading-overlay" *ngIf="detailAuxLoading" aria-live="polite">
          <div class="app-skeleton-line" *ngFor="let _ of detailSkeletonLines"></div>
        </div>
        <div class="detail-tabs">
          <button type="button" [class.active]="detailTab === 'overview'" (click)="setDetailTab('overview')">Synth√®se</button>
          <button type="button" [class.active]="detailTab === 'documents'" (click)="setDetailTab('documents')">Documents client</button>
        </div>
        <div class="detail-grid" *ngIf="detailTab === 'overview'">
          <div class="detail-section">
            <h4>Informations Utilisateur</h4>
            <div class="detail-item">
              <span class="detail-label">Nom d'utilisateur:</span>
              <span class="detail-value">{{ selectedBooking.user?.username || 'Utilisateur inconnu' }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Email:</span>
              <span class="detail-value">{{ selectedBooking.user?.email || 'Non communiqu√©' }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Identit√©:</span>
              <span class="identity-chip" [ngClass]="getIdentityBadgeClass(selectedBooking.identityStatus)">
                {{ getIdentityLabel(selectedBooking.identityStatus) }}
              </span>
            </div>
            <button 
              (click)="viewUserBookings(selectedBooking.user?.id, selectedBooking.user?.username)"
              class="btn-link">
              Voir toutes les r√©servations de cet utilisateur
            </button>
          </div>

          <div class="detail-section">
            <h4>D√©tails de l'Offre</h4>
            <div class="detail-item">
              <span class="detail-label">Service:</span>
              <span class="detail-value">{{ selectedBooking.offer?.mobilityService || 'Service inconnu' }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Lieu de d√©part:</span>
              <span class="detail-value">{{ selectedBooking.offer?.pickupLocation || 'Lieu non disponible' }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Prix:</span>
              <span class="detail-value price">{{ formatCurrency(selectedBooking.offer?.price) }}</span>
            </div>
          </div>

          <div class="detail-section">
            <h4>D√©tails de la R√©servation</h4>
            <div class="detail-item">
              <span class="detail-label">Date de r√©servation:</span>
              <span class="detail-value">{{ formatDate(selectedBooking.reservationDate) }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Statut:</span>
              <span [class]="'status-badge ' + getStatusClass(selectedBooking.status)">
                {{ getStatusText(selectedBooking.status) }}
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Date de cr√©ation:</span>
              <span class="detail-value">{{ formatDate(selectedBooking.createdAt) }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Prix total:</span>
              <span class="detail-value price-large">
                {{ formatCurrency(selectedBooking.totalPrice ?? selectedBooking.offer?.price) }}
              </span>
            </div>
          </div>

          <div class="detail-section">
            <h4>Statut de Paiement</h4>
            <div class="detail-item">
              <span class="detail-label">Paiement:</span>
              <span class="payment-badge" [ngClass]="getPaymentBadgeClass(selectedBooking.paymentStatus)">
                {{ getPaymentStatusText(selectedBooking.paymentStatus) }}
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">R√©f√©rence Stripe:</span>
              <span class="detail-value code-value">{{ selectedBooking.paymentReference || '‚Äî' }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Derni√®re mise √† jour:</span>
              <span class="detail-value">
                {{ formatDate(selectedBooking.paymentDate || selectedBooking.createdAt) }}
              </span>
            </div>
          </div>
          <div class="detail-section identity-documents" *ngIf="selectedBooking">
            <h4>Documents & statut d'identit√©</h4>
            <div class="detail-item">
              <span class="detail-label">Statut:</span>
              <span class="identity-chip" [ngClass]="getIdentityBadgeClass(selectedBooking.identityStatus)">
                {{ getIdentityLabel(selectedBooking.identityStatus) }}
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Derni√®re mise √† jour:</span>
              <span class="detail-value">
                {{ formatIdentityTimestamp(selectedBooking.identityUpdatedAt) }}
              </span>
            </div>
            <div class="detail-item" *ngIf="selectedBooking.identityReason">
              <span class="detail-label">Motif Stripe:</span>
              <span class="detail-value">{{ selectedBooking.identityReason }}</span>
            </div>
            <div class="identity-reminder" *ngIf="shouldShowIdentityReminder(selectedBooking)">
              <p>Relancez le client pour finaliser ses documents avant validation.</p>
              <a
                *ngIf="buildIdentityReminderLink(selectedBooking) as reminderLink"
                [href]="reminderLink"
                class="ghost-btn"
                target="_blank"
                rel="noopener">
                üìß Relancer par e-mail
              </a>
              <button
                type="button"
                class="primary-btn"
                (click)="viewUserBookings(selectedBooking.user?.id, selectedBooking.user?.username)">
                üîç Voir ses r√©servations
              </button>
            </div>
          </div>
          <div class="detail-section">
            <h4>Historique Stripe</h4>
            <ng-container *ngIf="paymentEventsLoading; else stripeHistory">
              <div class="detail-skeleton loading-state" aria-live="polite">
                <span class="app-skeleton-line" *ngFor="let _ of detailSkeletonLines"></span>
              </div>
            </ng-container>
            <ng-template #stripeHistory>
              <div *ngIf="paymentEventsError" class="warning-text">{{ paymentEventsError }}</div>
              <div *ngIf="!paymentEventsError && paymentEvents.length === 0" class="info-text">
                Aucun √©v√©nement Stripe enregistr√© pour cette r√©servation.
              </div>
              <ul *ngIf="!paymentEventsError && paymentEvents.length > 0" class="events-timeline">
                <li *ngFor="let event of paymentEvents">
                  <div class="event-header">
                    <span class="event-type badge badge-muted">{{ event.type }}</span>
                    <span class="event-date">{{ formatDate(event.receivedAt) }}</span>
                  </div>
                  <div class="event-status">
                    <span [ngClass]="getEventStatusBadgeClass(event.status)">
                      {{ event.status || '‚Äî' }}
                    </span>
                  </div>
                  <div class="event-id code-value">Event ID: {{ event.eventId }}</div>
                  <div class="event-error" *ngIf="event.errorMessage">
                    ‚ö†Ô∏è {{ event.errorMessage }}
                  </div>
                </li>
              </ul>
            </ng-template>
          </div>
          <div class="detail-section">
            <h4>Actions administrateur</h4>
            <ng-container *ngIf="adminActionsLoading; else adminActionsHistory">
              <div class="detail-skeleton loading-state" aria-live="polite">
                <span class="app-skeleton-line" *ngFor="let _ of detailSkeletonLines"></span>
              </div>
            </ng-container>
            <ng-template #adminActionsHistory>
              <div *ngIf="adminActionsError" class="warning-text">{{ adminActionsError }}</div>
              <div *ngIf="!adminActionsError && adminActions.length === 0" class="info-text">
                Aucune action administrateur enregistr√©e.
              </div>
              <ul *ngIf="!adminActionsError && adminActions.length > 0" class="events-timeline">
                <li *ngFor="let action of adminActions">
                  <div class="event-header">
                    <span class="event-type" [ngClass]="getAdminActionBadgeClass(action.actionType)">{{ action.actionType }}</span>
                    <span class="event-date">{{ formatDate(action.createdAt) }}</span>
                  </div>
                  <div class="event-status">
                    <span class="badge badge-muted">Admin</span>
                    <strong>{{ action.adminUsername }}</strong>
                  </div>
                  <div class="event-error" *ngIf="action.details">
                    {{ action.details }}
                  </div>
                </li>
              </ul>
            </ng-template>
          </div>
        </div>
        <div class="documents-pane" *ngIf="detailTab === 'documents'">
          <section class="documents-card">
            <div class="card-header">
              <h4>Profil conducteur</h4>
            </div>
            <div *ngIf="!selectedBooking?.driverProfile" class="info-text">
              Aucun profil conducteur enregistr√© sur cette r√©servation.
            </div>
            <ul *ngIf="selectedBooking?.driverProfile" class="driver-profile-list">
              <li><strong>Permis :</strong> {{ selectedBooking.driverProfile?.licenseNumber || '‚Äî' }}</li>
              <li><strong>Pays :</strong> {{ selectedBooking.driverProfile?.licenseCountry || '‚Äî' }}</li>
              <li><strong>Cat√©gorie :</strong> {{ selectedBooking.driverProfile?.licenseCategory || '‚Äî' }}</li>
              <li><strong>Expiration :</strong> {{ selectedBooking.driverProfile?.licenseExpiresOn ? (selectedBooking.driverProfile?.licenseExpiresOn | date:'dd/MM/yyyy') : '‚Äî' }}</li>
              <li><strong>Kilom√©trage annuel :</strong> {{ selectedBooking.driverProfile?.annualKilometers || '‚Äî' }}</li>
              <li><strong>Usage :</strong> {{ selectedBooking.driverProfile?.usageReason || '‚Äî' }}</li>
            </ul>
          </section>
          <section class="documents-card">
            <div class="card-header">
              <div>
                <h4>Documents Stripe</h4>
                <p>Pi√®ces re√ßues via Stripe Identity</p>
              </div>
              <div class="card-actions">
                <button type="button" class="ghost-btn" (click)="refreshIdentityDocuments()">‚Üª</button>
                <button type="button" class="primary-btn" (click)="requestIdentitySession()" [disabled]="identitySessionLoading">
                  {{ identitySessionLoading ? 'Demande en cours‚Ä¶' : 'Demander un nouveau scan' }}
                </button>
              </div>
            </div>
            <div *ngIf="identityDocumentsLoading" class="info-text">Chargement des documents...</div>
            <div *ngIf="identityDocumentsError" class="warning-text">{{ identityDocumentsError }}</div>
            <div *ngIf="!identityDocumentsLoading && !identityDocumentsError && identityDocuments.length === 0" class="info-text">
              Aucun document disponible pour ce client.
            </div>
            <ul *ngIf="identityDocuments.length > 0" class="documents-list">
              <li *ngFor="let doc of identityDocuments">
                <div class="doc-row">
                  <strong>{{ doc.documentType || 'Document' }}</strong>
                  <span class="doc-status">{{ doc.status || '‚Äî' }}</span>
                </div>
                <div class="doc-meta">
                  <span>Expiration : {{ doc.expirationDate ? (doc.expirationDate | date:'dd/MM/yyyy') : 'n/a' }}</span>
                  <span>Pays : {{ doc.issuingCountry || '‚Äî' }}</span>
                  <span *ngIf="doc.fileIds?.length">Fichiers : {{ doc.fileIds?.join(', ') }}</span>
                </div>
              </li>
            </ul>
          </section>
          <section class="documents-card">
            <div class="card-header">
              <h4>Historique des v√©rifications</h4>
            </div>
            <div *ngIf="identityVerificationsLoading" class="info-text">Chargement de l‚Äôhistorique...</div>
            <div *ngIf="identityVerificationsError" class="warning-text">{{ identityVerificationsError }}</div>
            <div *ngIf="!identityVerificationsLoading && !identityVerificationsError && identityVerifications.length === 0" class="info-text">
              Aucune v√©rification enregistr√©e.
            </div>
            <ul *ngIf="identityVerifications.length > 0" class="events-timeline">
              <li *ngFor="let record of identityVerifications">
                <div class="event-header">
                  <span class="event-type badge" [ngClass]="getIdentityBadgeClass(record.status)">{{ record.status }}</span>
                  <span class="event-date">{{ formatIdentityTimestamp(record.updatedAt) }}</span>
                </div>
                <div class="event-status">
                  <span class="badge badge-muted">Session</span>
                  <span class="code-value">{{ record.stripeSessionId || '‚Äî' }}</span>
                </div>
                <div class="event-error" *ngIf="record.reason">
                  {{ record.reason }}
                </div>
              </li>
            </ul>
          </section>
        </div>
      </div>
      <div class="modal-actions">
        <button 
          *ngIf="selectedBooking && canConfirmPaid(selectedBooking)"
          (click)="confirmBooking(selectedBooking)"
          class="btn-confirm-primary">
          ‚úÖ Confirmer la r√©servation
        </button>
        <button
          *ngIf="selectedBooking && canForceConfirm(selectedBooking)"
          (click)="confirmBookingForced(selectedBooking)"
          class="btn-force-confirm-text">
          ‚ö†Ô∏è Forcer la confirmation
        </button>
          <button (click)="closeDetailModal()" class="btn-cancel">
          Fermer
        </button>
        <div class="action-buttons" *ngIf="selectedBooking">
          <button 
            *ngIf="canConfirm(selectedBooking) && !canConfirmPaid(selectedBooking)"
            (click)="confirmBooking(selectedBooking)" 
            class="btn-confirm">
            ‚úÖ Confirmer
          </button>
          <button 
            *ngIf="canCollectPayment(selectedBooking)"
            (click)="collectPayment(selectedBooking)" 
            class="btn-payment">
            üí≥ Encaisser
          </button>
          <button
            *ngIf="canForceExpire(selectedBooking)"
            (click)="forcePaymentExpiration(selectedBooking)"
            class="btn-expire"
            [disabled]="isPaymentActionLoading(selectedBooking.reservationId)">
            ‚è≥ Expirer
          </button>
          <button
            *ngIf="canForceRefund(selectedBooking)"
            (click)="forcePaymentRefund(selectedBooking)"
            class="btn-refund"
            [disabled]="isPaymentActionLoading(selectedBooking.reservationId)">
            üí∏ Rembourser
          </button>
          <button 
            *ngIf="canCancel(selectedBooking)"
            (click)="cancelBooking(selectedBooking)" 
            class="btn-cancel-action">
            ‚ùå Annuler
          </button>
          <button 
            *ngIf="canComplete(selectedBooking)"
            (click)="completeBooking(selectedBooking)" 
            class="btn-complete">
            üèÅ Terminer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de confirmation de suppression -->
  <div *ngIf="isDeleteModalOpen" class="modal-overlay">
    <div class="modal card-surface" [class.loading-state]="isDeleteProcessing">
      <div class="modal-header">
        <h3>Confirmer la suppression</h3>
        <button (click)="isDeleteModalOpen = false" class="close-btn">√ó</button>
      </div>
      <div class="modal-content" *ngIf="selectedBooking; else deleteModalSkeleton">
        <p>√ätes-vous s√ªr de vouloir supprimer la r√©servation <strong>#{{ selectedBooking.reservationId }}</strong> ?</p>
        <p class="warning-text">Cette action est irr√©versible et supprimera d√©finitivement la r√©servation.</p>
        <div class="booking-preview">
          <strong>{{ selectedBooking.user?.username || 'Utilisateur inconnu' }}</strong> - 
          {{ selectedBooking.offer?.mobilityService || 'Service inconnu' }} - 
          {{ formatDate(selectedBooking.reservationDate) }}
        </div>
      </div>
      <div class="modal-actions">
        <button (click)="isDeleteModalOpen = false" class="btn-cancel">
          Annuler
        </button>
        <button (click)="deleteBooking()" class="btn-danger" [disabled]="isDeleteProcessing">
          üóëÔ∏è Supprimer
        </button>
      </div>
    </div>
  </div>
</div>

<ng-template #deleteModalSkeleton>
  <div class="modal-content loading-state">
    <div class="modal-skeleton-grid">
      <span class="app-skeleton-line" *ngFor="let _ of modalSkeletonLines"></span>
    </div>
  </div>
</ng-template>
