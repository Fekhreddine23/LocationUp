<!-- booking-management.html -->
<div class="booking-management-container">
  <app-breadcrumbs [items]="breadcrumbItems"></app-breadcrumbs>

  <div class="page-header">
    <div class="header-content">
      <h1>Gestion des R√©servations</h1>
      <p>Supervisez et g√©z toutes les r√©servations du syst√®me</p>
    </div>
    <button (click)="goBackToDashboard()" class="back-btn">
      ‚Üê Retour au Dashboard
    </button>
  </div>

  <!-- Messages -->
  <div *ngIf="successMessage" class="alert alert-success">
    ‚úÖ {{ successMessage }}
  </div>
  <div *ngIf="errorMessage" class="alert alert-error">
    ‚ùå {{ errorMessage }}
  </div>

  <!-- Statistiques -->
  <div class="stats-section" *ngIf="bookingStats.totalBookings">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">üìä</div>
        <div class="stat-content">
          <div class="stat-number">{{ bookingStats.totalBookings }}</div>
          <div class="stat-label">Total R√©servations</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚è≥</div>
        <div class="stat-content">
          <div class="stat-number">{{ bookingStats.pendingBookings }}</div>
          <div class="stat-label">En Attente</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-content">
          <div class="stat-number">{{ bookingStats.confirmedBookings }}</div>
          <div class="stat-label">Confirm√©es</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üí∞</div>
        <div class="stat-content">
          <div class="stat-number">{{ formatCurrency(bookingStats.totalRevenue) }}</div>
          <div class="stat-label">Revenu Total</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Barre de recherche et filtres -->
  <div class="filters-section">
    <div class="search-bar">
      <input 
        type="text" 
        [(ngModel)]="searchQuery" 
        (input)="searchBookings()"
        placeholder="Rechercher une r√©servation, utilisateur..."
        class="search-input">
      <button (click)="searchBookings()" class="search-btn">
        üîç Rechercher
      </button>
    </div>

    <div class="filter-controls">
      <select [(ngModel)]="statusFilter" (change)="applyFilters()" class="filter-select">
        <option value="ALL">Tous les statuts</option>
        <option value="PENDING">En attente</option>
        <option value="CONFIRMED">Confirm√©es</option>
        <option value="CANCELLED">Annul√©es</option>
        <option value="COMPLETED">Termin√©es</option>
      </select>

      <input 
        type="date" 
        [(ngModel)]="dateFilter" 
        (change)="applyFilters()"
        class="filter-input">

      <button (click)="loadBookings()" class="refresh-btn">
        üîÑ Actualiser
      </button>
    </div>
  </div>




  <!-- üÜï SECTION FILTRES ACTIFS - AJOUTE ICI -->
  <div class="active-filters" *ngIf="hasActiveFilters()">
    <div class="active-filter" *ngIf="getActiveUserFilter() as userFilter">
      <span class="filter-label">üë§ Utilisateur:</span>
      <span class="filter-value">{{ userFilter.name }}</span>
      <button (click)="clearUserFilter()" class="btn-clear-filter" title="Supprimer le filtre">
        √ó
      </button>
    </div>
    
    <div class="active-filter" *ngIf="statusFilter !== 'ALL'">
      <span class="filter-label">üìä Statut:</span>
      <span class="filter-value">{{ getStatusText(statusFilter) }}</span>
      <button (click)="clearStatusFilter()" class="btn-clear-filter" title="Supprimer le filtre">
        √ó
      </button>
    </div>
    
    <div class="active-filter" *ngIf="dateFilter">
      <span class="filter-label">üìÖ Date:</span>
      <span class="filter-value">{{ formatDisplayDate(dateFilter) }}</span>
      <button (click)="clearDateFilter()" class="btn-clear-filter" title="Supprimer le filtre">
        √ó
      </button>
    </div>
    
    <button *ngIf="hasMultipleFilters()" (click)="clearAllFilters()" class="btn-clear-all">
      üóëÔ∏è Supprimer tous les filtres
    </button>
  </div>









  <!-- Tableau des r√©servations -->
  <div class="bookings-table-container">
    <div class="table-header">
      <div class="table-stats">
        {{ displayedBookingsCount }} r√©servation(s) trouv√©e(s)
      </div>
    </div>

    <div *ngIf="isLoading" class="loading-state">
      Chargement des r√©servations...
    </div>

    <div *ngIf="!isLoading && filteredBookings.length === 0" class="empty-state">
      Aucune r√©servation trouv√©e
    </div>

    <table *ngIf="!isLoading && filteredBookings.length > 0" class="bookings-table">
      <thead>
        <tr>
          <th>R√©servation</th>
          <th>Utilisateur</th>
          <th>Service</th>
          <th>Date</th>
          <th>Prix</th>
          <th>Statut</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let booking of filteredBookings" class="booking-row">
          <td class="booking-info">
            <div class="booking-id">#{{ booking.reservationId }}</div>
            <div class="booking-date">
              Cr√©√©e le {{ formatShortDate(booking.createdAt) }}
            </div>
          </td>
          <td class="user-info">
            <div class="user-avatar">
              {{ booking.user?.username?.charAt(0)?.toUpperCase() || '?' }}
            </div>
            <div class="user-details">
              <strong>{{ booking.user?.username || 'Utilisateur inconnu' }}</strong>
              <span class="user-email">{{ booking.user?.email || 'Email non disponible' }}</span>
            </div>
          </td>
          <td class="service-info">
            <div class="service-name">{{ booking.offer?.mobilityService || 'Service inconnu' }}</div>
            <div class="service-location">{{ booking.offer?.pickupLocation || 'Lieu non disponible' }}</div>
          </td>
          <td class="reservation-date">
            {{ formatDate(booking.reservationDate) }}
          </td>
          <td class="booking-price">
            {{ formatCurrency(booking.totalPrice ?? booking.offer?.price) }}
          </td>
          <td>
            <span [class]="'status-badge ' + getStatusClass(booking.status)">
              {{ getStatusText(booking.status) }}
            </span>
          </td>
          <td class="actions">
            <button (click)="viewBookingDetails(booking)" class="btn-view" title="D√©tails">
              üëÅÔ∏è
            </button>
            <button 
              *ngIf="canConfirm(booking)"
              (click)="confirmBooking(booking)" 
              class="btn-confirm" 
              title="Confirmer">
              ‚úÖ
            </button>
            <button 
              *ngIf="canForceConfirm(booking)"
              (click)="confirmBookingForced(booking)" 
              class="btn-force-confirm" 
              title="Forcer la confirmation sans paiement">
              ‚ö†Ô∏è
            </button>
            <button 
              *ngIf="canCollectPayment(booking)"
              (click)="collectPayment(booking)" 
              class="btn-payment" 
              title="Encaisser via Stripe">
              üí≥
            </button>
            <button
              *ngIf="canForceExpire(booking)"
              (click)="forcePaymentExpiration(booking)"
              class="btn-expire"
              [disabled]="isPaymentActionLoading(booking.reservationId)"
              title="Forcer l'expiration du paiement">
              ‚è≥
            </button>
            <button
              *ngIf="canForceRefund(booking)"
              (click)="forcePaymentRefund(booking)"
              class="btn-refund"
              [disabled]="isPaymentActionLoading(booking.reservationId)"
              title="Rembourser manuellement">
              üí∏
            </button>
            <button 
              *ngIf="canCancel(booking)"
              (click)="cancelBooking(booking)" 
              class="btn-cancel" 
              title="Annuler">
              ‚ùå
            </button>
            <button 
              *ngIf="canComplete(booking)"
              (click)="completeBooking(booking)" 
              class="btn-complete" 
              title="Terminer">
              üèÅ
            </button>
            <button (click)="confirmDelete(booking)" class="btn-delete" title="Supprimer">
              üóëÔ∏è
            </button>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Pagination -->
    <div *ngIf="totalPages > 1" class="pagination">
      <button 
        (click)="goToPage(currentPage - 1)" 
        [disabled]="currentPage === 0"
        class="pagination-btn">
        ‚Üê Pr√©c√©dent
      </button>
      
      <span class="pagination-info">
        Page {{ currentPage + 1 }} sur {{ totalPages }}
      </span>
      
      <button 
        (click)="goToPage(currentPage + 1)" 
        [disabled]="currentPage >= totalPages - 1"
        class="pagination-btn">
        Suivant ‚Üí
      </button>
    </div>
  </div>

  <!-- Modal de d√©tails -->
  <div *ngIf="isDetailModalOpen" class="modal-overlay">
    <div class="modal large-modal">
      <div class="modal-header">
        <h3>D√©tails de la R√©servation #{{ selectedBooking?.reservationId }}</h3>
        <button (click)="isDetailModalOpen = false" class="close-btn">√ó</button>
      </div>
      <div class="modal-content" *ngIf="selectedBooking">
        <div class="detail-grid">
          <div class="detail-section">
            <h4>Informations Utilisateur</h4>
            <div class="detail-item">
              <span class="detail-label">Nom d'utilisateur:</span>
              <span class="detail-value">{{ selectedBooking.user?.username || 'Utilisateur inconnu' }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Email:</span>
              <span class="detail-value">{{ selectedBooking.user?.email || 'Non communiqu√©' }}</span>
            </div>
            <button 
              (click)="viewUserBookings(selectedBooking.user?.id)"
              class="btn-link">
              Voir toutes les r√©servations de cet utilisateur
            </button>
          </div>

          <div class="detail-section">
            <h4>D√©tails de l'Offre</h4>
            <div class="detail-item">
              <span class="detail-label">Service:</span>
              <span class="detail-value">{{ selectedBooking.offer?.mobilityService || 'Service inconnu' }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Lieu de d√©part:</span>
              <span class="detail-value">{{ selectedBooking.offer?.pickupLocation || 'Lieu non disponible' }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Prix:</span>
              <span class="detail-value price">{{ formatCurrency(selectedBooking.offer?.price) }}</span>
            </div>
          </div>

          <div class="detail-section">
            <h4>D√©tails de la R√©servation</h4>
            <div class="detail-item">
              <span class="detail-label">Date de r√©servation:</span>
              <span class="detail-value">{{ formatDate(selectedBooking.reservationDate) }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Statut:</span>
              <span [class]="'status-badge ' + getStatusClass(selectedBooking.status)">
                {{ getStatusText(selectedBooking.status) }}
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Date de cr√©ation:</span>
              <span class="detail-value">{{ formatDate(selectedBooking.createdAt) }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Prix total:</span>
              <span class="detail-value price-large">
                {{ formatCurrency(selectedBooking.totalPrice ?? selectedBooking.offer?.price) }}
              </span>
            </div>
          </div>

          <div class="detail-section">
            <h4>Statut de Paiement</h4>
            <div class="detail-item">
              <span class="detail-label">Paiement:</span>
              <span class="payment-badge" [ngClass]="getPaymentBadgeClass(selectedBooking.paymentStatus)">
                {{ getPaymentStatusText(selectedBooking.paymentStatus) }}
              </span>
            </div>
            <div class="detail-item">
              <span class="detail-label">R√©f√©rence Stripe:</span>
              <span class="detail-value code-value">{{ selectedBooking.paymentReference || '‚Äî' }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Derni√®re mise √† jour:</span>
              <span class="detail-value">
                {{ formatDate(selectedBooking.paymentDate || selectedBooking.createdAt) }}
              </span>
            </div>
          </div>
          <div class="detail-section">
            <h4>Historique Stripe</h4>
            <div *ngIf="paymentEventsLoading" class="info-text">Chargement des √©v√©nements...</div>
            <div *ngIf="paymentEventsError" class="warning-text">{{ paymentEventsError }}</div>
            <div *ngIf="!paymentEventsLoading && !paymentEventsError && paymentEvents.length === 0" class="info-text">
              Aucun √©v√©nement Stripe enregistr√© pour cette r√©servation.
            </div>
            <ul *ngIf="!paymentEventsLoading && paymentEvents.length > 0" class="events-timeline">
              <li *ngFor="let event of paymentEvents">
                <div class="event-header">
                  <span class="event-type">{{ event.type }}</span>
                  <span class="event-date">{{ formatDate(event.receivedAt) }}</span>
                </div>
                <div class="event-status">
                  Statut: <strong>{{ event.status }}</strong>
                </div>
                <div class="event-id">Event ID: {{ event.eventId }}</div>
                <div class="event-error" *ngIf="event.errorMessage">
                  ‚ö†Ô∏è {{ event.errorMessage }}
                </div>
              </li>
            </ul>
          </div>
          <div class="detail-section">
            <h4>Actions administrateur</h4>
            <div *ngIf="adminActionsLoading" class="info-text">Chargement des actions...</div>
            <div *ngIf="adminActionsError" class="warning-text">{{ adminActionsError }}</div>
            <div *ngIf="!adminActionsLoading && !adminActionsError && adminActions.length === 0" class="info-text">
              Aucune action administrateur enregistr√©e.
            </div>
            <ul *ngIf="!adminActionsLoading && adminActions.length > 0" class="events-timeline">
              <li *ngFor="let action of adminActions">
                <div class="event-header">
                  <span class="event-type">{{ action.actionType }}</span>
                  <span class="event-date">{{ formatDate(action.createdAt) }}</span>
                </div>
                <div class="event-status">
                  Admin: <strong>{{ action.adminUsername }}</strong>
                </div>
                <div class="event-error" *ngIf="action.details">
                  {{ action.details }}
                </div>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button 
          *ngIf="selectedBooking && canConfirmPaid(selectedBooking)"
          (click)="confirmBooking(selectedBooking)"
          class="btn-confirm-primary">
          ‚úÖ Confirmer la r√©servation
        </button>
        <button
          *ngIf="selectedBooking && canForceConfirm(selectedBooking)"
          (click)="confirmBookingForced(selectedBooking)"
          class="btn-force-confirm-text">
          ‚ö†Ô∏è Forcer la confirmation
        </button>
        <button (click)="isDetailModalOpen = false" class="btn-cancel">
          Fermer
        </button>
        <div class="action-buttons" *ngIf="selectedBooking">
          <button 
            *ngIf="canConfirm(selectedBooking) && !canConfirmPaid(selectedBooking)"
            (click)="confirmBooking(selectedBooking)" 
            class="btn-confirm">
            ‚úÖ Confirmer
          </button>
          <button 
            *ngIf="canCollectPayment(selectedBooking)"
            (click)="collectPayment(selectedBooking)" 
            class="btn-payment">
            üí≥ Encaisser
          </button>
          <button
            *ngIf="canForceExpire(selectedBooking)"
            (click)="forcePaymentExpiration(selectedBooking)"
            class="btn-expire"
            [disabled]="isPaymentActionLoading(selectedBooking.reservationId)">
            ‚è≥ Expirer
          </button>
          <button
            *ngIf="canForceRefund(selectedBooking)"
            (click)="forcePaymentRefund(selectedBooking)"
            class="btn-refund"
            [disabled]="isPaymentActionLoading(selectedBooking.reservationId)">
            üí∏ Rembourser
          </button>
          <button 
            *ngIf="canCancel(selectedBooking)"
            (click)="cancelBooking(selectedBooking)" 
            class="btn-cancel-action">
            ‚ùå Annuler
          </button>
          <button 
            *ngIf="canComplete(selectedBooking)"
            (click)="completeBooking(selectedBooking)" 
            class="btn-complete">
            üèÅ Terminer
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de confirmation de suppression -->
  <div *ngIf="isDeleteModalOpen" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3>Confirmer la suppression</h3>
        <button (click)="isDeleteModalOpen = false" class="close-btn">√ó</button>
      </div>
      <div class="modal-content" *ngIf="selectedBooking">
        <p>√ätes-vous s√ªr de vouloir supprimer la r√©servation <strong>#{{ selectedBooking.reservationId }}</strong> ?</p>
        <p class="warning-text">Cette action est irr√©versible et supprimera d√©finitivement la r√©servation.</p>
        <div class="booking-preview">
          <strong>{{ selectedBooking.user?.username || 'Utilisateur inconnu' }}</strong> - 
          {{ selectedBooking.offer?.mobilityService || 'Service inconnu' }} - 
          {{ formatDate(selectedBooking.reservationDate) }}
        </div>
      </div>
      <div class="modal-actions">
        <button (click)="isDeleteModalOpen = false" class="btn-cancel">
          Annuler
        </button>
        <button (click)="deleteBooking()" class="btn-danger">
          üóëÔ∏è Supprimer
        </button>
      </div>
    </div>
  </div>
</div>
