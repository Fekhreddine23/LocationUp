<!-- offer-management.html -->
<div class="offer-management-shell">
  <app-breadcrumbs [items]="breadcrumbItems"></app-breadcrumbs>

  <ng-container *ngIf="hasLoadedInitialData; else offerManagementSkeleton">
    <div class="offer-management-container">
      <div class="page-header card-surface">
        <div class="header-content">
          <h1>Gestion des Offres</h1>
          <p>Cr√©ez et g√©rez les offres de mobilit√© disponibles</p>
        </div>
        <button (click)="goBackToDashboard()" class="back-btn">
          ‚Üê Retour au Dashboard
        </button>
      </div>

      <!-- Messages -->
      <div *ngIf="successMessage" class="alert alert-success">
        ‚úÖ {{ successMessage }}
      </div>
      <div *ngIf="errorMessage" class="alert alert-error">
        ‚ùå {{ errorMessage }}
      </div>

      <!-- Barre d'actions -->
      <div class="actions-section card-surface">
        <button (click)="createOffer()" class="btn-primary">
          ‚ûï Nouvelle Offre
        </button>
      </div>

      <!-- Barre de recherche et filtres -->
      <div class="filters-section card-surface" [class.is-loading]="isLoading">
        <div class="search-bar">
          <input 
            type="text" 
            [(ngModel)]="searchQuery" 
            (input)="searchOffers()"
            placeholder="Rechercher une offre..."
            class="search-input">
          <button (click)="searchOffers()" class="search-btn">
            üîç Rechercher
          </button>
        </div>

        <div class="filter-controls">
          <select [(ngModel)]="statusFilter" (change)="applyFilters()" class="filter-select">
            <option value="ALL">Tous les statuts</option>
            <option value="PENDING">En attente</option>
            <option value="CONFIRMED">Confirm√©es</option>
            <option value="CANCELLED">Annul√©es</option>
            <option value="COMPLETED">Termin√©es</option>
          </select>

          <input 
            type="text" 
            [(ngModel)]="locationFilter" 
            (input)="applyFilters()"
            placeholder="Lieu..."
            class="filter-input">

          <button (click)="loadOffers()" class="refresh-btn">
            üîÑ Actualiser
          </button>
        </div>
      </div>

      <!-- Tableau des offres -->
      <div class="offers-table-container card-surface" [class.is-loading]="isLoading">
        <div class="table-header">
          <div class="table-stats">
            {{ totalElements }} offre(s) trouv√©e(s)
          </div>
        </div>

        <div 
          *ngIf="isLoading" 
          class="table-loading-skeleton loading-state" 
          aria-live="polite" 
          aria-label="Chargement des offres">
          <div class="skeleton-card" *ngFor="let _ of skeletonCards">
            <div class="app-skeleton-line" *ngFor="let __ of skeletonCardLines"></div>
            <div class="skeleton-actions">
              <span class="app-skeleton-pill" *ngFor="let __ of skeletonActionButtons"></span>
            </div>
          </div>
        </div>

        <div *ngIf="!isLoading && filteredOffers.length === 0" class="empty-state">
          Aucune offre trouv√©e
        </div>

        <div *ngIf="!isLoading && filteredOffers.length > 0" class="offers-grid">
          <div *ngFor="let offer of filteredOffers" class="offer-card">
            <div class="offer-header">
              {{ offer.mobilityService || offer.mobilityService || 'Service non pr√©cis√©' }}
              <span [class]="'status-badge ' + getStatusClass(offer.status)">
                {{ getStatusText(offer.status) }}
              </span>
            </div>
            
            <div class="offer-content">
              <div class="offer-info">
                <div class="info-item">
                  <span class="info-label">üìç D√©part:</span>
                  <span class="info-value">
                    {{ offer.pickupLocationName || offer.pickupLocation || 'Lieu non pr√©cis√©' }}
                  </span>
                </div>
                <div class="info-item">
                  <span class="info-label">üéØ Retour:</span>
                  <span class="info-value">
                    {{ offer.returnLocationName || offer.returnLocation || 'Lieu non pr√©cis√©' }}
                  </span>
                </div>
                <div class="info-item">
                  <span class="info-label">üìÖ Date:</span>
                  <span class="info-value">{{ formatDate(offer.pickupDatetime) }}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">üí∞ Prix:</span>
                  <span class="info-value price">{{ formatCurrency(offer.price) }}</span>
                </div>
                <div class="info-item" *ngIf="offer.adminName">
                  <span class="info-label">üë§ Admin:</span>
                  <span class="info-value">{{ offer.adminName }}</span>
                </div>
              </div>
              
              <div *ngIf="offer.description" class="offer-description">
                {{ offer.description }}
              </div>
            </div>

            <div class="offer-actions">
              <button (click)="editOffer(offer)" class="btn-edit" title="Modifier">
                ‚úèÔ∏è Modifier
              </button>
              <button 
                (click)="toggleOfferStatus(offer)" 
                [class]="isOfferConfirmed(offer) ? 'btn-deactivate' : 'btn-activate'"
                [title]="isOfferConfirmed(offer) ? 'Annuler l\'offre' : 'Confirmer l\'offre'"
                [disabled]="!canToggleStatus(offer)">
                {{ isOfferConfirmed(offer) ? '‚èπÔ∏è Annuler' : '‚úÖ Confirmer' }}
              </button>
              <button (click)="confirmDelete(offer)" class="btn-delete" title="Supprimer">
                üóëÔ∏è Supprimer
              </button>
            </div>
          </div>
        </div>

        <!-- Pagination -->
        <div *ngIf="totalPages > 1" class="pagination">
          <button 
            (click)="goToPage(currentPage - 1)" 
            [disabled]="currentPage === 0"
            class="pagination-btn">
            ‚Üê Pr√©c√©dent
          </button>
          
          <span class="pagination-info">
            Page {{ currentPage + 1 }} sur {{ totalPages }}
          </span>
          
          <button 
            (click)="goToPage(currentPage + 1)" 
            [disabled]="currentPage >= totalPages - 1"
            class="pagination-btn">
            Suivant ‚Üí
          </button>
        </div>
      </div>
    </div>
  </ng-container>

  <ng-template #offerManagementSkeleton>
    <div class="offer-management-container skeleton-container" aria-label="Chargement des offres">
      <div class="page-header card-surface">
        <div class="header-content">
          <div class="app-skeleton-line" style="width: 60%;"></div>
          <div class="app-skeleton-line" style="width: 40%;"></div>
        </div>
        <div class="skeleton-button app-skeleton-pill"></div>
      </div>

      <div class="actions-section card-surface">
        <div class="app-skeleton-pill" style="width: 220px;"></div>
      </div>

      <div class="filters-section card-surface">
        <div class="skeleton-filter-grid">
          <div class="app-skeleton-line" *ngFor="let _ of skeletonFilters"></div>
        </div>
      </div>

      <div class="offers-grid">
        <div class="offer-card skeleton-card" *ngFor="let _ of skeletonCards">
          <div class="app-skeleton-line" *ngFor="let __ of skeletonCardLines"></div>
          <div class="skeleton-actions">
            <span class="app-skeleton-pill" *ngFor="let __ of skeletonActionButtons"></span>
          </div>
        </div>
      </div>
    </div>
  </ng-template>

  <!-- Modal de cr√©ation -->
  <div *ngIf="isCreateModalOpen" class="modal-overlay">
    <div class="modal large-modal">
      <div class="modal-header">
        <h3>Cr√©er une nouvelle offre</h3>
        <button (click)="isCreateModalOpen = false" class="close-btn">√ó</button>
      </div>
      <div class="modal-content">
        <ng-container *ngIf="!isLoadingServices; else serviceSkeleton">
        <div class="form-grid">
          <div class="form-row">
            <div class="form-group half">
              <label>Lieu de d√©part *</label>
              <input 
                type="text" 
                [(ngModel)]="newOffer.pickupLocation" 
                name="newPickupLocation"
                class="form-input"
                placeholder="Adresse de d√©part">
            </div>
            <div class="form-group half">
              <label>Ville de d√©part *</label>
              <input 
                type="text" 
                [(ngModel)]="newOffer.pickupLocationCity" 
                name="newPickupCity"
                class="form-input"
                placeholder="Ex: Paris">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group half">
              <label>Lieu de retour *</label>
              <input 
                type="text" 
                [(ngModel)]="newOffer.returnLocation" 
                name="newReturnLocation"
                class="form-input"
                placeholder="Adresse de retour">
            </div>
            <div class="form-group half">
              <label>Ville de retour *</label>
              <input 
                type="text" 
                [(ngModel)]="newOffer.returnLocationCity" 
                name="newReturnCity"
                class="form-input"
                placeholder="Ex: Marseille">
            </div>
          </div>


          <div class="form-group">
            <label>Cat√©gorie de mobilit√© *</label>
            <select 
              [(ngModel)]="newOffer.mobilityService" 
              name="newMobilityService"
              class="form-input"
              [disabled]="isLoadingServices">
              <option value="">S√©lectionnez une cat√©gorie</option>
              <option *ngFor="let category of mobilityCategories" [value]="category">
                {{ category }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label>ID administrateur *</label>
            <input 
              type="number" 
              [(ngModel)]="newOffer.adminId" 
              name="newAdminId"
              class="form-input"
              min="1"
              step="1"
              placeholder="Ex: 12">
          </div>

          <div class="form-group">
            <label>Date et heure de prise en charge *</label>
            <input 
              type="datetime-local" 
              [(ngModel)]="newOffer.pickupDatetime" 
              name="newPickupDatetime"
              class="form-input">
          </div>

          <div class="form-group">
            <label>Prix (‚Ç¨) *</label>
            <input 
              type="number" 
              [(ngModel)]="newOffer.price" 
              name="newPrice"
              class="form-input"
              min="0.01"
              step="0.01">
          </div>

          <div class="form-group">
            <label>Statut *</label>
            <select [(ngModel)]="newOffer.status" name="newStatus" class="form-input">
              <option value="PENDING">En attente</option>
              <option value="CONFIRMED">Confirm√©e</option>
              <option value="CANCELLED">Annul√©e</option>
              <option value="COMPLETED">Termin√©e</option>
            </select>
          </div>

          <div class="form-group full-width">
            <label>Description</label>
            <textarea 
              [(ngModel)]="newOffer.description" 
              name="newDescription"
              class="form-textarea"
              placeholder="Description de l'offre..."
              rows="3"></textarea>
          </div>

          <div class="form-group full-width">
            <label>Image de l'offre</label>
            <input 
              type="file" 
              accept="image/*"
              (change)="onNewOfferImageSelected($event)"
              class="form-input">
            <small class="muted">Formats accept√©s : JPG, PNG, WEBP - max 5MB</small>
            <div class="image-preview" *ngIf="newOfferImagePreview">
              <img [src]="newOfferImagePreview" alt="Aper√ßu de l'image s√©lectionn√©e">
            </div>
          </div>

          <div class="form-group full-width">
            <label>Galerie (jusqu'√† 5 images)</label>
            <input 
              type="file" 
              accept="image/*"
              multiple
              (change)="onNewOfferGallerySelected($event)"
              class="form-input">
            <small class="muted">Formats accept√©s : JPG, PNG, WEBP - max 5MB par image</small>
            <div class="gallery-preview" *ngIf="newOfferGalleryPreviews.length">
              <img *ngFor="let img of newOfferGalleryPreviews" [src]="img" alt="Aper√ßu galerie">
            </div>
          </div>
        </div>
        </ng-container>
      </div>
      <div class="modal-actions">
        <button (click)="isCreateModalOpen = false" class="btn-cancel">
          Annuler
        </button>
        <button 
          (click)="submitNewOffer()" 
          [disabled]="!isValidOffer() || isLoadingServices || imageUploadLoading"
          class="btn-confirm">
          {{ imageUploadLoading ? 'T√©l√©versement...' : (isLoadingServices ? 'Chargement...' : 'Cr√©er l\'offre') }}
        </button>
      </div>
    </div>
  </div>

  <!-- Modal d'√©dition -->
  <div *ngIf="isEditModalOpen" class="modal-overlay">
    <div class="modal large-modal">
      <div class="modal-header">
        <h3>Modifier l'offre</h3>
        <button (click)="isEditModalOpen = false" class="close-btn">√ó</button>
      </div>
      <div class="modal-content" *ngIf="selectedOffer">
        <ng-container *ngIf="!isLoadingServices; else serviceSkeleton">
        <div class="form-grid">
          <div class="form-row">
            <div class="form-group half">
              <label>Lieu de d√©part</label>
              <input 
                type="text" 
                [(ngModel)]="selectedOffer.pickupLocation" 
                name="editPickupLocation"
                class="form-input">
            </div>
            <div class="form-group half">
              <label>Ville de d√©part</label>
              <input 
                type="text" 
                [(ngModel)]="selectedOffer.pickupLocationCity" 
                name="editPickupCity"
                class="form-input">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group half">
              <label>Lieu de retour</label>
              <input 
                type="text" 
                [(ngModel)]="selectedOffer.returnLocation" 
                name="editReturnLocation"
                class="form-input">
            </div>
            <div class="form-group half">
              <label>Ville de retour</label>
              <input 
                type="text" 
                [(ngModel)]="selectedOffer.returnLocationCity" 
                name="editReturnCity"
                class="form-input">
            </div>
          </div>


          <div class="form-group">
            <label>Cat√©gorie de mobilit√©</label>
            <select 
              [(ngModel)]="selectedOffer.mobilityService" 
              class="form-input"
              [disabled]="isLoadingServices">
              <option value="">S√©lectionnez une cat√©gorie</option>
              <option *ngFor="let category of mobilityCategories" [value]="category">
                {{ category }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label>ID administrateur</label>
            <input 
              type="number" 
              [(ngModel)]="selectedOffer.adminId" 
              class="form-input"
              min="1"
              step="1">
          </div>

          <div class="form-group">
            <label>Date et heure</label>
            <input 
              type="datetime-local" 
              [value]="selectedOffer.pickupDatetime | date:'yyyy-MM-ddTHH:mm'"
              (input)="selectedOffer.pickupDatetime = $any($event.target).value"
              class="form-input">
          </div>

          <div class="form-group">
            <label>Prix (‚Ç¨)</label>
            <input 
              type="number" 
              [(ngModel)]="selectedOffer.price" 
              class="form-input"
              min="0.01"
              step="0.01">
          </div>

          <div class="form-group">
            <label>Statut</label>
            <select [(ngModel)]="selectedOffer.status" class="form-input">
              <option value="PENDING">En attente</option>
              <option value="CONFIRMED">Confirm√©e</option>
              <option value="CANCELLED">Annul√©e</option>
              <option value="COMPLETED">Termin√©e</option>
            </select>
          </div>

          <div class="form-group full-width">
            <label>Description</label>
            <textarea 
              [(ngModel)]="selectedOffer.description" 
              class="form-textarea"
              rows="3"></textarea>
          </div>

          <div class="form-group full-width">
            <label>Image de l'offre</label>
            <input 
              type="file" 
              accept="image/*"
              (change)="onEditOfferImageSelected($event)"
              class="form-input">
            <small class="muted">Formats accept√©s : JPG, PNG, WEBP - max 5MB</small>
            <div class="image-preview" *ngIf="selectedOfferImagePreview || selectedOffer.imageUrl">
              <img [src]="selectedOfferImagePreview || selectedOffer.imageUrl" alt="Aper√ßu de l'image s√©lectionn√©e">
            </div>
          </div>

          <div class="form-group full-width">
            <label>Galerie (jusqu'√† 5 images)</label>
            <input 
              type="file" 
              accept="image/*"
              multiple
              (change)="onEditOfferGallerySelected($event)"
              class="form-input">
            <small class="muted">Formats accept√©s : JPG, PNG, WEBP - max 5MB par image</small>
            <div class="gallery-preview" *ngIf="selectedOfferGalleryPreviews.length || selectedOffer.galleryUrls?.length">
              <img *ngFor="let img of (selectedOfferGalleryPreviews.length ? selectedOfferGalleryPreviews : selectedOffer.galleryUrls)" [src]="img" alt="Aper√ßu galerie">
            </div>
          </div>
        </div>
        </ng-container>
      </div>
      <div class="modal-actions">
        <button (click)="isEditModalOpen = false" class="btn-cancel">
          Annuler
        </button>
        <button (click)="updateOffer()" class="btn-confirm" [disabled]="imageUploadLoading">
          {{ imageUploadLoading ? 'T√©l√©versement...' : 'Enregistrer' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de confirmation de suppression -->
  <div *ngIf="isDeleteModalOpen" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <h3>Confirmer la suppression</h3>
        <button (click)="isDeleteModalOpen = false" class="close-btn">√ó</button>
      </div>
      <div class="modal-content" *ngIf="selectedOffer">
        <p>√ätes-vous s√ªr de vouloir supprimer l'offre <strong>{{ selectedOffer.mobilityService || 'Service non pr√©cis√©' }}</strong> ?</p>
        <p class="warning-text">Cette action est irr√©versible.</p>
      </div>
      <div class="modal-actions">
        <button (click)="isDeleteModalOpen = false" class="btn-cancel">
          Annuler
        </button>
        <button (click)="deleteOffer()" class="btn-danger">
          Supprimer
        </button>
      </div>
    </div>
  </div>

  <ng-template #serviceSkeleton>
    <div class="modal-loading loading-state" aria-live="polite">
      <div class="app-skeleton-line" *ngFor="let _ of skeletonCardLines"></div>
    </div>
  </ng-template>
</div>
