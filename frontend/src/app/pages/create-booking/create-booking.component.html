<app-breadcrumbs [items]="breadcrumbItems"></app-breadcrumbs>

<div class="create-booking-container">
  <div class="booking-form-card">
    <div class="wizard-header">
      <div>
        <h2>Nouvelle R√©servation</h2>
        <p>Validez votre offre, renseignez vos d√©tails puis lancez le paiement en toute simplicit√©.</p>
      </div>
    </div>

    <div class="wizard-steps">
      <div 
        class="wizard-step"
        *ngFor="let step of steps; index as i"
        [class.active]="isStepActive(step.id)"
        [class.completed]="isStepCompleted(step.id)">
        <div class="step-index">{{ i + 1 }}</div>
        <div class="step-icon">{{ step.icon }}</div>
        <div class="step-label">{{ step.label }}</div>
      </div>
    </div>

    <div *ngIf="errorMessage" class="alert alert-error">
      ‚ùå {{ errorMessage }}
    </div>

    <div *ngIf="successMessage && currentStep === 'payment'" class="alert alert-success">
      ‚úÖ {{ successMessage }}
    </div>

    <ng-container [ngSwitch]="currentStep">
      <!-- Step 1 -->
      <section *ngSwitchCase="'offer'">
        <div *ngIf="isLoadingOffer" class="loading-offer">
          <div class="spinner"></div>
          <p>Chargement de l'offre s√©lectionn√©e...</p>
        </div>

        <ng-container *ngIf="!isLoadingOffer">
          <div *ngIf="selectedOffer; else noOffer">
            <div class="selected-offer-section">
              <h3>üéØ Offre s√©lectionn√©e</h3>
              <div class="offer-card selected">
                <div class="offer-header">
                  <div>
                    <h4>{{ selectedOffer.description }}</h4>
                    <p class="offer-id">ID Offre: {{ selectedOffer.offerId }}</p>
                  </div>
                  <span class="price-tag">{{ selectedOffer.price | currency:'EUR' }}</span>
                </div>
                <div class="offer-details">
                  <p><strong>Service:</strong> {{ selectedOffer.mobilityService || '‚Äî' }}</p>
                  <p>
                    <strong>Disponibilit√©:</strong>
                    {{ selectedOffer.pickupDatetime | date:'dd/MM/yyyy √† HH:mm' }}
                  </p>
                </div>
                <div class="offer-note">
                  <small>Cette offre provient de votre s√©lection dans le catalogue.</small>
                </div>
              </div>
            </div>

            <div class="step-actions">
              <button class="btn btn-secondary" type="button" (click)="onCancel()">
                üîé Choisir une autre offre
              </button>
              <button class="btn btn-primary" type="button" (click)="goToDetailsStep()">
                Continuer vers les d√©tails ‚Üí
              </button>
            </div>
          </div>
          <ng-template #noOffer>
            <div class="no-offer-message">
              <div class="warning-icon">‚ö†Ô∏è</div>
              <h3>Aucune offre s√©lectionn√©e</h3>
              <p>Choisissez une offre depuis le catalogue pour poursuivre la r√©servation.</p>
              <button class="btn btn-primary" (click)="onCancel()">
                üìã Voir les offres disponibles
              </button>
            </div>
          </ng-template>
        </ng-container>
      </section>

      <!-- Step 2 -->
      <section *ngSwitchCase="'details'">
        <div class="identity-block" *ngIf="!identityLoading && identityStatus?.status?.toUpperCase() !== 'VERIFIED'">
          <div class="identity-icon">‚ö†Ô∏è</div>
          <div class="identity-text">
            <h4>V√©rification d'identit√© requise</h4>
            <p>Pour valider votre r√©servation et acc√©der au paiement, merci de terminer la v√©rification.</p>
            <button class="btn btn-outline" type="button" routerLink="/profile#identity">
              V√©rifier mon identit√© ‚Üí
            </button>
          </div>
        </div>
        <form (ngSubmit)="submitDetails()" #detailsForm="ngForm">
          <div class="form-group">
            <label for="reservationDate">Date et heure de r√©servation *</label>
            <input 
              type="datetime-local"
              id="reservationDate"
              name="reservationDate"
              [(ngModel)]="bookingRequest.reservationDate"
              required
              class="form-control"
              [disabled]="creationLoading"
              [min]="getMinDate()"
              [max]="getMaxDate()">
            <small class="form-help">
              Choisissez l'heure exacte de votre trajet pour cette offre.
            </small>
          </div>

          <div class="form-group" *ngIf="bookingRequest.userId > 0">
            <label>Utilisateur</label>
            <div class="user-info">
              <strong>ID:</strong> {{ bookingRequest.userId }}
              <span *ngIf="currentUser">({{ currentUser.username }})</span>
            </div>
          </div>

          <div *ngIf="bookingRequest.reservationDate" class="preview-section">
            <h4>üìã Aper√ßu</h4>
            <div class="preview-details">
              <div class="preview-item">
                <strong>Offre :</strong> {{ selectedOffer?.description }}
              </div>
              <div class="preview-item">
                <strong>Date :</strong> {{ bookingRequest.reservationDate | date:'dd/MM/yyyy HH:mm' }}
              </div>
              <div class="preview-item">
                <strong>Montant :</strong> {{ selectedOffer?.price | currency:'EUR' }}
              </div>
            </div>
          </div>

          <div class="step-actions">
            <button type="button" class="btn btn-secondary" (click)="goBackToOffer()">
              ‚Üê Retour √† l'offre
            </button>
            <button 
              type="submit"
              class="btn btn-primary"
              [disabled]="!detailsForm.form.valid || creationLoading">
              {{ creationLoading ? '‚è≥ Cr√©ation en cours...' : 'Valider et passer au paiement' }}
            </button>
          </div>
        </form>
      </section>

      <!-- Step 3 -->
      <section *ngSwitchCase="'payment'" class="payment-step">
        <div *ngIf="createdBooking as booking">
          <div class="payment-summary">
            <h3>üí≥ Paiement s√©curis√©</h3>
            <p>R√©servation #{{ booking.reservationId }} ‚Äî {{ selectedOffer?.description }}</p>
            <ul>
              <li><strong>Date :</strong> {{ booking.reservationDate | date:'dd/MM/yyyy HH:mm' }}</li>
              <li><strong>Montant :</strong> {{ selectedOffer?.price | currency:'EUR' }}</li>
              <li><strong>Statut :</strong> {{ booking.status }}</li>
            </ul>
          </div>
          <div class="payment-status" [class.error]="paymentError">
            <p *ngIf="paymentStatusMessage">{{ paymentStatusMessage }}</p>
            <p *ngIf="paymentLoading">Vous allez √™tre redirig√© vers Stripe...</p>
            <div *ngIf="paymentError" class="alert alert-warning">
              ‚ùå {{ paymentError }}
              <p>Vous pourrez relancer le paiement ci-dessous.</p>
            </div>
          </div>

          <div class="step-actions">
            <button type="button" class="btn btn-secondary" (click)="navigateToBookings()">
              üìã Voir mes r√©servations
            </button>
            <button
              type="button"
              class="btn btn-primary"
              [disabled]="paymentLoading || !booking.reservationId"
              (click)="startPayment(booking.reservationId!)">
              {{ paymentLoading ? 'Redirection en cours...' : 'üí≥ Relancer le paiement' }}
            </button>
          </div>
        </div>
      </section>
    </ng-container>
  </div>
</div>
