<ng-container *ngIf="(isAdmin$ | async); else adminRestricted">
<div class="finance-container" *ngIf="overview as data; else financeLoading">
  <app-breadcrumbs [items]="breadcrumbItems"></app-breadcrumbs>

  <div class="header">
    <div>
      <h1>Finances</h1>
      <p>Suivi temps r√©el des revenus et des paiements</p>
    </div>
    <div class="actions">
      <select [(ngModel)]="selectedRange" (change)="refreshRange(selectedRange)">
        <option [value]="3">3 derniers mois</option>
        <option [value]="6">6 derniers mois</option>
        <option [value]="12">12 derniers mois</option>
      </select>
      <button (click)="downloadCsv()">‚¨áÔ∏è Export CSV</button>
    </div>
  </div>

  <div class="metrics">
    <div class="metric-card">
      <span>Total revenus</span>
      <strong>{{ data.totalRevenue | number:'1.2-2' }} ‚Ç¨</strong>
    </div>
    <div class="metric-card">
      <span>Mois en cours</span>
      <strong>{{ data.monthToDateRevenue | number:'1.2-2' }} ‚Ç¨</strong>
    </div>
    <div class="metric-card warning">
      <span>En attente</span>
      <strong>{{ data.outstandingRevenue | number:'1.2-2' }} ‚Ç¨</strong>
    </div>
    <div class="metric-card success">
      <span>Taux de confirmation</span>
      <strong>{{ data.confirmationRate | percent:'1.0-1' }}</strong>
    </div>
  </div>

  <div class="chart-card">
    <h3>√âvolution des revenus</h3>
    <canvas baseChart
      [data]="lineChartData"
      [options]="lineChartOptions"
      [type]="'line'">
    </canvas>
  </div>

  <div class="outstanding-card">
    <h3>En cours de paiement</h3>
    <div class="outstanding-columns">
      <div>
        <h4>8 derni√®res semaines</h4>
        <ul *ngIf="data.outstandingByWeek.length; else noWeekData">
          <li *ngFor="let point of data.outstandingByWeek">
            <div>
              <strong>{{ formatWeekLabel(point) }}</strong>
              <small>{{ point.count }} dossiers</small>
            </div>
            <span>{{ point.amount | number:'1.2-2' }} ‚Ç¨</span>
          </li>
        </ul>
        <ng-template #noWeekData>
          <p class="muted">Rien √† signaler sur les derni√®res semaines.</p>
        </ng-template>
      </div>
      <div>
        <h4>6 derniers mois</h4>
        <ul *ngIf="data.outstandingByMonth.length; else noMonthData">
          <li *ngFor="let point of data.outstandingByMonth">
            <div>
              <strong>{{ formatMonthLabel(point) }}</strong>
              <small>{{ point.count }} dossiers</small>
            </div>
            <span>{{ point.amount | number:'1.2-2' }} ‚Ç¨</span>
          </li>
        </ul>
        <ng-template #noMonthData>
          <p class="muted">Aucun encours sur les derniers mois.</p>
        </ng-template>
      </div>
    </div>
  </div>

  <div class="critical-alerts card-surface" *ngIf="highlightedAlerts.length">
    <div class="card-header">
      <div>
        <h3>Alertes critiques prioritaires</h3>
        <p>Suivi rapproch√© des dossiers √† risque identifi√©s dans les 24h</p>
      </div>
      <button type="button" class="ghost" (click)="setAlertSeverity('CRITIQUE')">
        Voir toutes les critiques
      </button>
    </div>
    <div class="critical-alerts-grid">
      <article class="critical-alert-card" *ngFor="let alert of highlightedAlerts | slice:0:3; trackBy: trackByReservation">
        <header>
          <span class="alert-chip" [ngClass]="alert.severity.toLowerCase()">
            {{ alert.severity }}
          </span>
          <span class="alert-id">#{{ alert.reservationId }}</span>
        </header>
        <p class="alert-message">{{ alert.message }}</p>
        <ul class="alert-meta">
          <li><strong>Client :</strong> {{ alert.customer }}</li>
          <li><strong>Montant :</strong> {{ alert.amount | number:'1.2-2' }} ‚Ç¨</li>
          <li><strong>Statut :</strong> {{ alert.paymentStatus }}</li>
          <li><strong>Cr√©√©e :</strong> {{ alert.reservationDate | date:'dd/MM HH:mm' }}</li>
        </ul>
        <div class="alert-actions">
          <button type="button" class="primary" (click)="viewAlertDetails(alert)">Analyser</button>
          <button type="button" class="ghost" (click)="navigateToBooking(alert)">Ouvrir la r√©servation</button>
        </div>
      </article>
    </div>
  </div>

  <div class="status-grid">
    <div class="status-card" *ngFor="let status of data.paymentsByStatus">
      <div class="status-icon" [class]="getStatusClass(status.status)"></div>
      <div>
        <p>{{ status.status }}</p>
        <strong>{{ status.amount | number:'1.2-2' }} ‚Ç¨</strong>
        <small>{{ status.count }} paiements</small>
        <span *ngIf="isActionRequiredStatus(status.status)" class="badge badge-warning">Action requise</span>
      </div>
    </div>
  </div>

  <div class="alerts-card">
    <div class="card-header">
      <h3>Alertes paiements</h3>
      <div class="alert-actions">
        <button type="button" class="ghost" (click)="loadAlerts()">‚Üª</button>
        <button class="primary" (click)="downloadAlertsCsv()">‚¨áÔ∏è Export anomalies</button>
      </div>
    </div>
    <div class="alert-filters">
      <div class="severity-toggle">
        <button type="button" (click)="setAlertSeverity('ALL')" [class.active]="alertSeverityFilter === 'ALL'">Toutes</button>
        <button type="button" (click)="setAlertSeverity('ALERTE')" [class.active]="alertSeverityFilter === 'ALERTE'">Alerte</button>
        <button type="button" (click)="setAlertSeverity('CRITIQUE')" [class.active]="alertSeverityFilter === 'CRITIQUE'">Critique</button>
        <button type="button" class="chip" [class.active]="alertActionOnly" (click)="toggleActionRequired()">Action requise</button>
      </div>
      <div class="status-chips">
        <label *ngFor="let status of alertStatusOptions">
          <input type="checkbox" [(ngModel)]="alertStatusSelection[status]" (change)="onStatusToggle()" />
          <span>{{ status }}</span>
        </label>
      </div>
      <div class="date-filter">
        <label>
          Du
          <input type="date" [(ngModel)]="alertDateStart">
        </label>
        <label>
          Au
          <input type="date" [(ngModel)]="alertDateEnd">
        </label>
      </div>
      <div class="alert-search">
        <input [(ngModel)]="alertSearch" type="search" placeholder="Rechercher une alerte..." (keyup.enter)="applyAlertFilters()">
        <button type="button" class="ghost" (click)="applyAlertFilters()">Filtrer</button>
        <button type="button" class="ghost" (click)="resetAlertFilters()">R√©initialiser</button>
      </div>
    </div>
    <div class="responsive-table">
      <table>
        <thead>
          <tr>
            <th>Gravit√©</th>
            <th>R√©servation</th>
            <th>Client</th>
            <th>Montant</th>
            <th>Statut</th>
            <th>Message</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngIf="alertsLoading">
            <td colspan="6">Chargement des alertes...</td>
          </tr>
          <tr *ngFor="let alert of filteredAlerts">
            <td><span class="badge" [class]="'severity-' + alert.severity.toLowerCase()">{{ alert.severity }}</span></td>
            <td>#{{ alert.reservationId }}</td>
            <td>{{ alert.customer }}</td>
            <td>{{ alert.amount | number:'1.2-2' }} ‚Ç¨</td>
            <td><span [class]="'badge ' + getStatusClass(alert.paymentStatus)">{{ alert.paymentStatus }}</span></td>
            <td>{{ alert.message }}</td>
            <td class="alert-actions-cell">
              <button type="button" class="ghost" (click)="viewAlertDetails(alert)" title="Analyser">
                üëÅÔ∏è
              </button>
              <button type="button" class="ghost" (click)="navigateToBooking(alert)" title="Ouvrir dans les r√©servations">
                üîó
              </button>
            </td>
          </tr>
          <tr *ngIf="!alertsLoading && !filteredAlerts.length">
            <td colspan="7">Aucune alerte pour ce filtre üéâ</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <section class="alert-detail-panel card-surface" *ngIf="selectedAlert as alertDetail">
    <header class="panel-header">
      <div>
        <h3>Analyse r√©servation #{{ alertDetail.reservationId }}</h3>
        <p>Client : <strong>{{ alertDetail.customer }}</strong> ¬∑ {{ alertDetail.amount | number:'1.2-2' }} ‚Ç¨ ¬∑ {{ alertDetail.paymentStatus }}</p>
      </div>
      <div class="panel-actions">
        <button type="button" class="ghost" (click)="navigateToBooking(alertDetail)">
          ‚ÜóÔ∏é Ouvrir dans Booking Management
        </button>
        <button type="button" class="ghost" (click)="closeAlertDetails()">‚úï</button>
      </div>
    </header>
    <div class="alert-detail-grid">
      <div>
        <small>Gravit√©</small>
        <p><span class="badge" [class]="'severity-' + alertDetail.severity.toLowerCase()">{{ alertDetail.severity }}</span></p>
      </div>
      <div>
        <small>Date de r√©servation</small>
        <p>{{ alertDetail.reservationDate | date:'fullDate' }} √† {{ alertDetail.reservationDate | date:'HH:mm' }}</p>
      </div>
      <div>
        <small>Message</small>
        <p>{{ alertDetail.message }}</p>
      </div>
    </div>
    <div class="alert-timeline">
      <h4>Historique des √©v√©nements de paiement</h4>
      <div class="timeline-loading" *ngIf="alertEventsLoading">
        <span class="spinner"></span>
        <span>Chargement...</span>
      </div>
      <div class="timeline-error" *ngIf="!alertEventsLoading && alertEventsError">
        {{ alertEventsError }}
      </div>
      <ul class="timeline" *ngIf="!alertEventsLoading && !alertEventsError && alertEvents.length">
        <li *ngFor="let event of alertEvents">
          <div class="timeline-node" [ngClass]="event.status?.toLowerCase()">
            <span class="event-type">{{ event.type }}</span>
            <span class="event-status badge">{{ event.status }}</span>
            <span class="event-date">{{ event.receivedAt | date:'dd/MM HH:mm' }}</span>
            <span class="event-ref" *ngIf="event.reservationReference">Ref: {{ event.reservationReference }}</span>
            <span class="event-error" *ngIf="event.errorMessage">{{ event.errorMessage }}</span>
          </div>
        </li>
      </ul>
      <p class="muted" *ngIf="!alertEventsLoading && !alertEventsError && !alertEvents.length">
        Aucun √©v√©nement Stripe r√©cent pour cette r√©servation.
      </p>
    </div>
  </section>

  <div class="events-card">
    <div class="card-header">
      <h3>√âv√©nements Stripe r√©cents</h3>
      <button (click)="loadEvents()">‚Üª Rafra√Æchir</button>
    </div>
    <div class="responsive-table">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Type</th>
            <th>Statut</th>
            <th>R√©f√©rence</th>
            <th>Erreur</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let event of events">
            <td>{{ event.receivedAt | date:'dd/MM HH:mm' }}</td>
            <td>{{ event.type }}</td>
            <td><span [class]="'badge ' + getStatusClass(event.status)">{{ event.status }}</span></td>
            <td>{{ event.reservationReference || 'N/A' }}</td>
            <td>
              <span *ngIf="event.errorMessage; else okMsg">{{ event.errorMessage }}</span>
              <ng-template #okMsg>‚Äî</ng-template>
            </td>
          </tr>
          <tr *ngIf="eventsLoading">
            <td colspan="5">Chargement des √©v√©nements...</td>
          </tr>
          <tr *ngIf="!eventsLoading && events.length === 0">
            <td colspan="5">Aucun √©v√©nement r√©cent</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
</ng-container>

<ng-template #adminRestricted>
  <div class="finance-container locked">
    <app-breadcrumbs [items]="breadcrumbItems"></app-breadcrumbs>
    <div class="locked-card">
      <span class="emoji">üîí</span>
      <h2>Espace r√©serv√©</h2>
      <p>Cette section est disponible uniquement pour les administrateurs habilit√©s.</p>
      <a routerLink="/dashboard" class="back-btn">Retourner √† mon espace</a>
    </div>
  </div>
</ng-template>

<ng-template #financeLoading>
  <div class="finance-container loading-state">
    <app-breadcrumbs [items]="breadcrumbItems"></app-breadcrumbs>
    <div class="skeleton-grid">
      <div class="skeleton-card" *ngFor="let item of [1,2,3,4]"></div>
    </div>
    <div class="skeleton-chart"></div>
    <div class="skeleton-table"></div>
  </div>
</ng-template>
