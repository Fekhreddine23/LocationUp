<!-- profile.component.html (version mise √† jour) -->
<app-breadcrumbs [items]="breadcrumbItems"></app-breadcrumbs>

<div class="profile-container">
  <div class="profile-header">
    <h1>Mon Profil</h1>
    <p>G√©rez vos informations personnelles et vos pr√©f√©rences</p>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-state">
    <div class="spinner"></div>
    <p>Chargement de votre profil...</p>
  </div>

  <!-- Error Message -->
  <div *ngIf="errorMessage" class="alert alert-error">
    ‚ùå {{ errorMessage }}
  </div>

  <!-- Profile Content -->
  <div *ngIf="!isLoading && user" class="profile-content">
    
    <!-- Section Informations Personnelles -->
    <div class="profile-section">
      <h2>Informations Personnelles</h2>
      <div class="profile-info-grid">
        
        <!-- Photo de Profil -->
        <div class="profile-photo-section">
          <div class="profile-avatar">
            <img *ngIf="avatarPreview; else initialsAvatar" [src]="avatarPreview" alt="Avatar utilisateur" />
            <ng-template #initialsAvatar>
              <div class="avatar-placeholder">
                {{ getInitials() }}
              </div>
            </ng-template>
          </div>
          <label class="btn btn-outline btn-sm">
            üì∑ Changer la photo
            <input type="file" accept="image/*" (change)="onAvatarSelected($event)" hidden>
          </label>
          <button class="btn btn-text btn-sm" type="button" (click)="clearAvatar()" *ngIf="avatarPreview">
            R√©initialiser
          </button>
          <small class="text-muted" *ngIf="avatarMessage">{{ avatarMessage }}</small>
        </div>

        <!-- MODE LECTURE -->
        <div *ngIf="!isEditing" class="profile-details">
          <div class="info-item">
            <label>Nom d'utilisateur</label>
            <div class="info-value">{{ user.username }}</div>
          </div>

          <div class="info-item">
            <label>Email</label>
            <div class="info-value">{{ user.email || 'Non sp√©cifi√©' }}</div>
          </div>

          <div class="info-item">
            <label>R√¥le</label>
            <div class="info-value">
              <span class="role-badge" [class]="getRoleClass()">
                {{ getRoleText() }}
              </span>
            </div>
          </div>

          <div class="info-item">
            <label>Membre depuis</label>
            <div class="info-value">{{ getMemberSince() }}</div>
          </div>

          <div class="info-item">
            <label>ID Utilisateur</label>
            <div class="info-value">{{ user.id }}</div>
          </div>
        </div>

        <!-- MODE √âDITION -->
        <div *ngIf="isEditing" class="profile-details edit-form">
          <div class="info-item">
            <label for="username">Nom d'utilisateur</label>
            <input 
              id="username"
              type="text" 
              [(ngModel)]="editForm.username"
              class="form-input"
              placeholder="Votre nom d'utilisateur">
          </div>

          <div class="info-item">
            <label for="email">Email</label>
            <input 
              id="email"
              type="email" 
              [(ngModel)]="editForm.email"
              class="form-input"
              placeholder="votre@email.com">
          </div>

          <div class="info-item">
            <label>R√¥le</label>
            <div class="info-value">
              <span class="role-badge" [class]="getRoleClass()">
                {{ getRoleText() }}
              </span>
              <small class="text-muted">(Non modifiable)</small>
            </div>
          </div>

          <div class="info-item">
            <label>Membre depuis</label>
            <div class="info-value">{{ getMemberSince() }}</div>
          </div>

          <div class="info-item">
            <label>ID Utilisateur</label>
            <div class="info-value">{{ user.id }}</div>
          </div>
        </div>

      </div>
    </div>

    <!-- Section Statistiques -->
    <div class="profile-section">
      <h2>Statistiques</h2>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number">{{ userStats.totalBookings }}</div>
          <div class="stat-label">R√©servations totales</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{ userStats.activeBookings }}</div>
          <div class="stat-label">R√©servations actives</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{ userStats.cancelledBookings }}</div>
          <div class="stat-label">R√©servations annul√©es</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{ userStats.completedBookings }}</div>
          <div class="stat-label">R√©servations termin√©es</div>
        </div>
      </div>
    </div>

    <div class="profile-section admin-panel" *ngIf="isAdmin">
      <div class="section-header">
        <div>
          <h2>Espace administrateur</h2>
          <p>Pilotage des finances, utilisateurs et r√©servations en un clic.</p>
        </div>
      </div>
      <div class="admin-grid">
        <button class="admin-card" type="button" (click)="goToAdminHome()">
          <span class="admin-icon">üìä</span>
          <div>
            <strong>Dashboard global</strong>
            <p>Vue d‚Äôensemble et alertes critiques</p>
          </div>
          <span class="action-arrow">‚Üí</span>
        </button>
        <button class="admin-card" type="button" (click)="goToAdminFinance()">
          <span class="admin-icon">üí∂</span>
          <div>
            <strong>Finance & identit√©</strong>
            <p>Encaissements, v√©rifications et anomalies</p>
          </div>
          <span class="action-arrow">‚Üí</span>
        </button>
        <button class="admin-card" type="button" (click)="goToAdminUsers()">
          <span class="admin-icon">üßë‚Äçüíº</span>
          <div>
            <strong>Gestion utilisateurs</strong>
            <p>Profils, r√¥les et activit√©s</p>
          </div>
          <span class="action-arrow">‚Üí</span>
        </button>
        <button class="admin-card" type="button" (click)="goToAdminBookings()">
          <span class="admin-icon">üìÖ</span>
          <div>
            <strong>Gestion r√©servations</strong>
            <p>Suivi et intervention en temps r√©el</p>
          </div>
          <span class="action-arrow">‚Üí</span>
        </button>
      </div>
    </div>

<div class="profile-section preferences-section">
      <div class="section-header">
        <div>
          <h2>Pr√©f√©rences de mobilit√©</h2>
          <p>Personnalisez vos suggestions et alertes.</p>
          <p id="preferences-desc" class="sr-only">
            Ajustez vos modes favoris, budgets et alertes de mani√®re √† recevoir uniquement les offres qui
            correspondent √† vos priorit√©s.
          </p>
        </div>
      </div>
      <div class="preferences-grid">
        <label>
          Mode favori
          <span id="mode-favorite-desc" class="sr-only">
            S√©lectionnez votre mode de transport privil√©gi√© pour filtrer les recommandations.
          </span>
          <select [(ngModel)]="mobilityPreferences.favoriteCategory" aria-describedby="mode-favorite-desc">
            <option value="Voiture">Voiture</option>
            <option value="V√©lo">V√©lo</option>
            <option value="Trottinette">Trottinette</option>
            <option value="Scooter">Scooter</option>
            <option value="Moto">Moto</option>
          </select>
        </label>
        <label>
          Budget maximal (‚Ç¨)
          <span id="budget-max-desc" class="sr-only">
            Indiquez la somme maximale que vous √™tes pr√™t √† d√©penser par r√©servation.
          </span>
          <input type="number" min="10" step="5" [(ngModel)]="mobilityPreferences.maxBudget" aria-describedby="budget-max-desc">
        </label>
        <label class="toggle">
          <input type="checkbox" [(ngModel)]="mobilityPreferences.ecoFriendlyOnly" aria-describedby="toggle-eco-desc">
          <span id="toggle-eco-desc" class="sr-only">Prioriser les v√©hicules √† faible √©mission de CO2.</span>
          <span>Prioriser les v√©hicules bas carbone</span>
        </label>
        <label class="toggle">
          <input type="checkbox" [(ngModel)]="mobilityPreferences.autopilotNotifications" aria-describedby="toggle-autopilot-desc">
          <span id="toggle-autopilot-desc" class="sr-only">
            Recevoir une notification d√®s qu‚Äôune offre correspondant √† vos crit√®res est disponible.
          </span>
          <span>M'avertir d√®s qu'une offre correspondante appara√Æt</span>
        </label>
      </div>
      <div class="preferences-actions">
        <button class="btn primary" type="button" (click)="saveMobilityPreferences()">üíæ Sauvegarder</button>
      </div>
    </div>

    <div class="profile-section history-section">
      <div class="section-header">
        <div>
          <h2>Historique des r√©servations</h2>
          <p>Derni√®res activit√©s et statuts de vos trajets.</p>
        </div>
        <button class="btn btn-outline btn-sm" type="button" (click)="goToBookings()">Tout voir</button>
      </div>
      <div *ngIf="bookingHistoryLoading" class="loading-state">
        Chargement de l‚Äôhistorique...
      </div>
      <div *ngIf="bookingHistoryError" class="alert alert-warning">
        ‚ö†Ô∏è {{ bookingHistoryError }}
      </div>
      <ul class="timeline" *ngIf="!bookingHistoryLoading && !bookingHistoryError && bookingHistory.length">
        <li *ngFor="let booking of bookingHistory">
          <div class="timeline-icon">{{ getTimelineIcon(booking.status) }}</div>
          <div class="timeline-body">
            <div class="timeline-header">
              <strong>R√©servation #{{ booking.reservationId }}</strong>
              <span [class]="getBookingStatusBadge(booking.status)">{{ booking.status }}</span>
            </div>
            <p>
              {{ formatBookingDate(booking) }} ¬∑ Offre #{{ booking.offerId }} ¬∑
              {{ booking.paymentStatus || 'Paiement en attente' }}
            </p>
            <div class="timeline-actions">
              <button class="btn btn-link" type="button" (click)="navigateToBooking(booking)">
                D√©tails
              </button>
              <button class="btn btn-link" type="button" *ngIf="canRetryPayment(booking)" (click)="retryPayment(booking)">
                Relancer le paiement
              </button>
              <button class="btn btn-link" type="button" *ngIf="canDownloadReceipt(booking)" (click)="downloadReceipt(booking)">
                T√©l√©charger le re√ßu
              </button>
            </div>
          </div>
        </li>
      </ul>
      <div *ngIf="!bookingHistoryLoading && !bookingHistoryError && bookingHistory.length === 0" class="empty-state">
        Aucune r√©servation pour le moment.
      </div>
    </div>

    <!-- Section V√©rification d'identit√© -->
    <div class="profile-section identity-section">
      <div class="identity-header">
        <h2>V√©rification d'identit√©</h2>
        <p>Ajoutez vos documents officiels pour acc√©l√©rer la validation des r√©servations.</p>
      </div>
      <div class="identity-card" [class.loading]="identityLoading">
        <div class="identity-status">
          <span>Statut actuel :</span>
          <span class="identity-badge" [ngClass]="getIdentityBadgeClass()">
            {{ getIdentityLabel() }}
          </span>
        </div>
        <small class="identity-updated" *ngIf="identityStatus?.updatedAt">
          Mis √† jour le {{ identityStatus?.updatedAt | date:'dd/MM √† HH:mm' }}
        </small>
        <p class="identity-reason" *ngIf="identityStatus?.reason">
          {{ identityStatus?.reason }}
        </p>
        <div class="identity-actions">
          <button class="btn primary" type="button"
                  (click)="startIdentityVerification()"
                  [disabled]="identityActionLoading">
            <span *ngIf="identityActionLoading" class="mini-spinner"></span>
            {{ identityActionLoading ? 'Ouverture de Stripe‚Ä¶' : 'V√©rifier mon identit√©' }}
          </button>
          <button class="btn ghost" type="button"
                  (click)="refreshIdentityStatus()"
                  [disabled]="identityLoading">
            ‚Üª Actualiser
          </button>
        </div>
        <p class="identity-hint">
          Vos documents sont g√©r√©s de mani√®re s√©curis√©e via Stripe Identity. Une notification vous sera envoy√©e lors de la validation.
        </p>
      </div>
      <div *ngIf="identityError" class="alert alert-warning">
        ‚ö†Ô∏è {{ identityError }}
      </div>
    </div>

    <div class="profile-section driver-profile-section">
      <div class="section-header">
        <div>
          <h2>Profil conducteur</h2>
          <p>Nous pr√©-remplissons vos prochaines r√©servations avec ces informations.</p>
        </div>
        <span class="status-pill" *ngIf="driverProfileLoading">Chargement‚Ä¶</span>
      </div>
      <div class="driver-profile-grid">
        <label>
          Num√©ro de permis
          <input type="text" [(ngModel)]="driverProfile.licenseNumber" [disabled]="driverProfileLoading || driverProfileSaving">
        </label>
        <label>
          Pays d'√©mission
          <input type="text" [(ngModel)]="driverProfile.licenseCountry" maxlength="4" [disabled]="driverProfileLoading || driverProfileSaving">
        </label>
        <label>
          Cat√©gorie
          <input type="text" [(ngModel)]="driverProfile.licenseCategory" [disabled]="driverProfileLoading || driverProfileSaving">
        </label>
        <label>
          Expiration
          <input type="date" [(ngModel)]="driverProfile.licenseExpiresOn" [disabled]="driverProfileLoading || driverProfileSaving">
        </label>
        <label>
          Kilom√©trage annuel estim√©
          <input type="number" min="0" step="1000" [(ngModel)]="driverProfile.annualKilometers" [disabled]="driverProfileLoading || driverProfileSaving">
        </label>
        <label class="full-width">
          Usage principal
          <textarea rows="2" [(ngModel)]="driverProfile.usageReason" [disabled]="driverProfileLoading || driverProfileSaving"></textarea>
        </label>
      </div>
      <div class="driver-profile-actions">
        <button class="btn primary" type="button" (click)="saveDriverProfile()" [disabled]="driverProfileLoading || driverProfileSaving">
          {{ driverProfileSaving ? 'Enregistrement...' : 'üíæ Enregistrer le profil' }}
        </button>
        <span class="helper-text" *ngIf="driverProfileMessage">{{ driverProfileMessage }}</span>
      </div>
    </div>

    <!-- Section S√©curit√© / 2FA -->
    <div class="profile-section security-section" *ngIf="user">
      <h2>S√©curit√© & alertes</h2>
      <div class="security-grid">
        <div class="security-card">
          <h3>Authentification √† deux facteurs</h3>
          <p>Ajoutez une couche de s√©curit√© via un code unique.</p>
          <app-two-factor-setup
            [username]="user.username"
            (onComplete)="loadUserProfile()">
          </app-two-factor-setup>
        </div>
        <div class="security-card">
          <h3>Alertes en temps r√©el</h3>
          <p id="security-alerts-desc" class="sr-only">
            G√©rez les notifications critiques par email, SMS ou en cas de connexion suspecte.
          </p>
          <label class="toggle">
            <input type="checkbox" [(ngModel)]="securityPreferences.emailAlerts" aria-describedby="alert-email-desc security-alerts-desc">
            <span>Alerter par email (paiements, identit√©)</span>
            <span id="alert-email-desc" class="sr-only">
              Recevoir un email lors d‚Äôun paiement suspect ou d‚Äôun changement d‚Äôidentit√©.
            </span>
          </label>
          <label class="toggle">
            <input type="checkbox" [(ngModel)]="securityPreferences.smsAlerts" aria-describedby="alert-sms-desc security-alerts-desc">
            <span>Alerter par SMS pour les actions critiques</span>
            <span id="alert-sms-desc" class="sr-only">
              Obtenir un SMS pour les actions sensibles (ajout de moyen de paiement, etc.).
            </span>
          </label>
          <label class="toggle">
            <input type="checkbox" [(ngModel)]="securityPreferences.suspiciousLoginAlerts" aria-describedby="alert-login-desc security-alerts-desc">
            <span>Alerter en cas de connexion suspecte</span>
            <span id="alert-login-desc" class="sr-only">
              Signaler toute tentative de connexion inhabituelle.
            </span>
          </label>
          <button class="btn primary" type="button" (click)="saveSecurityPreferences()">üíæ Sauvegarder</button>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="profile-actions">
      <!-- Mode Lecture -->
      <div *ngIf="!isEditing" class="action-buttons quick-actions">
        <button class="action-card primary" (click)="editProfile()">
          <span class="action-icon">‚úèÔ∏è</span>
          <div class="action-text">
            <span class="action-title">Modifier le profil</span>
            <span class="action-subtitle">Mettez √† jour vos informations personnelles</span>
          </div>
          <span class="action-arrow">‚Üí</span>
        </button>
        <button class="action-card surface" (click)="goToBookings()">
          <span class="action-icon">üìã</span>
          <div class="action-text">
            <span class="action-title">Voir mes r√©servations</span>
            <span class="action-subtitle">Consultez l'historique et les r√©servations actives</span>
          </div>
          <span class="action-arrow">‚Üí</span>
        </button>
        <button class="action-card ghost" (click)="goToDashboard()">
          <span class="action-icon">üìä</span>
          <div class="action-text">
            <span class="action-title">Tableau de bord</span>
            <span class="action-subtitle">Acc√©dez √† vos statistiques globales</span>
          </div>
          <span class="action-arrow">‚Üí</span>
        </button>
      </div>

      <!-- Mode √âdition -->
      <div *ngIf="isEditing" class="action-buttons edit-mode">
        <button class="btn btn-success" (click)="saveProfile()" [disabled]="isLoading">
          üíæ Sauvegarder
        </button>
        <button class="btn btn-outline" (click)="cancelEdit()" [disabled]="isLoading">
          ‚ùå Annuler
        </button>
      </div>
    </div>

  </div>
</div>
