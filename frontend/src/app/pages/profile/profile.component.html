<!-- profile.component.html (version mise √† jour) -->
<app-breadcrumbs [items]="breadcrumbItems"></app-breadcrumbs>

<div class="profile-container">
  <div class="profile-header">
    <h1>Mon Profil</h1>
    <p>G√©rez vos informations personnelles et vos pr√©f√©rences</p>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-state">
    <div class="spinner"></div>
    <p>Chargement de votre profil...</p>
  </div>

  <!-- Error Message -->
  <div *ngIf="errorMessage" class="alert alert-error">
    ‚ùå {{ errorMessage }}
  </div>

  <!-- Profile Content -->
  <div *ngIf="!isLoading && user" class="profile-content">
    
    <!-- Section Informations Personnelles -->
    <div class="profile-section">
      <h2>Informations Personnelles</h2>
      <div class="profile-info-grid">
        
        <!-- Photo de Profil -->
        <div class="profile-photo-section">
          <div class="profile-avatar">
            <div class="avatar-placeholder">
              {{ getInitials() }}
            </div>
          </div>
          <button class="btn btn-outline btn-sm" disabled>
            üì∑ Changer la photo
          </button>
        </div>

        <!-- MODE LECTURE -->
        <div *ngIf="!isEditing" class="profile-details">
          <div class="info-item">
            <label>Nom d'utilisateur</label>
            <div class="info-value">{{ user.username }}</div>
          </div>

          <div class="info-item">
            <label>Email</label>
            <div class="info-value">{{ user.email || 'Non sp√©cifi√©' }}</div>
          </div>

          <div class="info-item">
            <label>R√¥le</label>
            <div class="info-value">
              <span class="role-badge" [class]="getRoleClass()">
                {{ getRoleText() }}
              </span>
            </div>
          </div>

          <div class="info-item">
            <label>Membre depuis</label>
            <div class="info-value">{{ getMemberSince() }}</div>
          </div>

          <div class="info-item">
            <label>ID Utilisateur</label>
            <div class="info-value">{{ user.id }}</div>
          </div>
        </div>

        <!-- MODE √âDITION -->
        <div *ngIf="isEditing" class="profile-details edit-form">
          <div class="info-item">
            <label for="username">Nom d'utilisateur</label>
            <input 
              id="username"
              type="text" 
              [(ngModel)]="editForm.username"
              class="form-input"
              placeholder="Votre nom d'utilisateur">
          </div>

          <div class="info-item">
            <label for="email">Email</label>
            <input 
              id="email"
              type="email" 
              [(ngModel)]="editForm.email"
              class="form-input"
              placeholder="votre@email.com">
          </div>

          <div class="info-item">
            <label>R√¥le</label>
            <div class="info-value">
              <span class="role-badge" [class]="getRoleClass()">
                {{ getRoleText() }}
              </span>
              <small class="text-muted">(Non modifiable)</small>
            </div>
          </div>

          <div class="info-item">
            <label>Membre depuis</label>
            <div class="info-value">{{ getMemberSince() }}</div>
          </div>

          <div class="info-item">
            <label>ID Utilisateur</label>
            <div class="info-value">{{ user.id }}</div>
          </div>
        </div>

      </div>
    </div>

    <!-- Section Statistiques -->
    <div class="profile-section">
      <h2>Statistiques</h2>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number">{{ userStats.totalBookings }}</div>
          <div class="stat-label">R√©servations totales</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{ userStats.activeBookings }}</div>
          <div class="stat-label">R√©servations actives</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{ userStats.cancelledBookings }}</div>
          <div class="stat-label">R√©servations annul√©es</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{ userStats.completedBookings }}</div>
          <div class="stat-label">R√©servations termin√©es</div>
        </div>
      </div>
    </div>

    <!-- Section V√©rification d'identit√© -->
    <div class="profile-section identity-section">
      <div class="identity-header">
        <h2>V√©rification d'identit√©</h2>
        <p>Ajoutez vos documents officiels pour acc√©l√©rer la validation des r√©servations.</p>
      </div>
      <div class="identity-card" [class.loading]="identityLoading">
        <div class="identity-status">
          <span>Statut actuel :</span>
          <span class="identity-badge" [ngClass]="getIdentityBadgeClass()">
            {{ getIdentityLabel() }}
          </span>
        </div>
        <small class="identity-updated" *ngIf="identityStatus?.updatedAt">
          Mis √† jour le {{ identityStatus?.updatedAt | date:'dd/MM √† HH:mm' }}
        </small>
        <p class="identity-reason" *ngIf="identityStatus?.reason">
          {{ identityStatus?.reason }}
        </p>
        <div class="identity-actions">
          <button class="btn primary" type="button"
                  (click)="startIdentityVerification()"
                  [disabled]="identityActionLoading">
            <span *ngIf="identityActionLoading" class="mini-spinner"></span>
            {{ identityActionLoading ? 'Ouverture de Stripe‚Ä¶' : 'V√©rifier mon identit√©' }}
          </button>
          <button class="btn ghost" type="button"
                  (click)="refreshIdentityStatus()"
                  [disabled]="identityLoading">
            ‚Üª Actualiser
          </button>
        </div>
        <p class="identity-hint">
          Vos documents sont g√©r√©s de mani√®re s√©curis√©e via Stripe Identity. Une notification vous sera envoy√©e lors de la validation.
        </p>
      </div>
      <div *ngIf="identityError" class="alert alert-warning">
        ‚ö†Ô∏è {{ identityError }}
      </div>
    </div>

    <!-- Section S√©curit√© / 2FA -->
    <div class="profile-section" *ngIf="user">
      <h2>S√©curit√©</h2>
      <p class="section-subtitle">
        Activez l'authentification √† deux facteurs pour s√©curiser davantage votre compte.
      </p>
      <app-two-factor-setup
        [username]="user.username"
        (onComplete)="loadUserProfile()">
      </app-two-factor-setup>
    </div>

    <!-- Actions -->
    <div class="profile-actions">
      <!-- Mode Lecture -->
      <div *ngIf="!isEditing" class="action-buttons quick-actions">
        <button class="action-card primary" (click)="editProfile()">
          <span class="action-icon">‚úèÔ∏è</span>
          <div class="action-text">
            <span class="action-title">Modifier le profil</span>
            <span class="action-subtitle">Mettez √† jour vos informations personnelles</span>
          </div>
          <span class="action-arrow">‚Üí</span>
        </button>
        <button class="action-card surface" (click)="goToBookings()">
          <span class="action-icon">üìã</span>
          <div class="action-text">
            <span class="action-title">Voir mes r√©servations</span>
            <span class="action-subtitle">Consultez l'historique et les r√©servations actives</span>
          </div>
          <span class="action-arrow">‚Üí</span>
        </button>
        <button class="action-card ghost" (click)="goToDashboard()">
          <span class="action-icon">üìä</span>
          <div class="action-text">
            <span class="action-title">Tableau de bord</span>
            <span class="action-subtitle">Acc√©dez √† vos statistiques globales</span>
          </div>
          <span class="action-arrow">‚Üí</span>
        </button>
      </div>

      <!-- Mode √âdition -->
      <div *ngIf="isEditing" class="action-buttons edit-mode">
        <button class="btn btn-success" (click)="saveProfile()" [disabled]="isLoading">
          üíæ Sauvegarder
        </button>
        <button class="btn btn-outline" (click)="cancelEdit()" [disabled]="isLoading">
          ‚ùå Annuler
        </button>
      </div>
    </div>

  </div>
</div>
