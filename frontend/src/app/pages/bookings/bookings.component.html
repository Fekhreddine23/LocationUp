 <!-- Ajouter le breadcrumb en haut -->
<app-breadcrumbs [items]="breadcrumbItems"></app-breadcrumbs>

<div class="bookings-container">
  <div class="bookings-header">
    <h1>Mes R√©servations</h1>
    <button class="btn btn-primary" (click)="createNewBooking()">
      + Nouvelle R√©servation
    </button>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading && bookings.length === 0" class="loading-state">
    <app-spinner text="Chargement de vos r√©servations..."></app-spinner>
  </div>

  <!-- Error Message -->
  <div *ngIf="errorMessage" class="alert alert-error">
    ‚ùå {{ errorMessage }}
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading && bookings.length === 0" class="empty-state">
    <div class="empty-icon">üìã</div>
    <h3>Aucune r√©servation</h3>
    <p>Vous n'avez pas encore de r√©servation.</p>
    <button class="btn btn-primary" (click)="createNewBooking()">
      Cr√©er ma premi√®re r√©servation
    </button>
  </div>

  <!-- Bookings List -->
  <div *ngIf="!isLoading && bookings.length > 0" class="bookings-list">
    
    <!-- Filtres et statistiques -->
    <div class="bookings-filters">
      <div class="stats">
        <span class="stat">
          <strong>{{ bookings.length }}</strong> r√©servation(s)
        </span>
        <span class="stat">
          <span class="status-badge status-pending">{{ getCountByStatus('PENDING') }}</span> En attente
        </span>
        <span class="stat">
          <span class="status-badge status-confirmed">{{ getCountByStatus('CONFIRMED') }}</span> Confirm√©es
        </span>
        <span class="stat">
          <span class="status-badge status-cancelled">{{ getCountByStatus('CANCELLED') }}</span> Annul√©es
        </span>
      </div>
    </div>

    <!-- Loading pendant le rechargement -->
    <div *ngIf="isLoading && bookings.length > 0" class="loading-overlay">
      <app-spinner size="small" text="Mise √† jour..."></app-spinner>
    </div>

    <!-- Liste des r√©servations -->
    <div class="booking-cards">
      <div *ngFor="let booking of bookings" 
           class="booking-card"
           [class]="getStatusCardClass(booking.status)">
        
        <!-- En-t√™te de la carte -->
        <div class="booking-header">
          <div class="booking-info">
            <h3 class="booking-title">
              R√©servation #{{ booking.reservationId }}
            </h3>
            <span class="booking-date">
              Cr√©√©e le {{ formatDate(booking.reservationDate) }}
            </span>
          </div>

          <div class="booking-status">
            <span [class]="'status-badge ' + getStatusBadgeClass(booking.status)">
              {{ getStatusText(booking.status) }}
            </span>
          </div>
        </div>

        <!-- D√©tails de l'offre (charg√©s dynamiquement) -->
        <div *ngIf="getOfferDetails(booking.offerId)" class="offer-details">
          <h4>{{ getOfferDetails(booking.offerId).description }}</h4>
          <div class="offer-meta">
            <span class="price">{{ getOfferDetails(booking.offerId).price | currency:'EUR' }}</span>
            <span class="pickup-date">
              üìÖ Disponible le {{ formatDate(getOfferDetails(booking.offerId).pickupDatetime) }}
            </span>
          </div>
        </div>

        <!-- D√©tails de la r√©servation -->
        <div class="booking-details">
          <div class="detail-item">
            <strong>ID R√©servation:</strong> {{ booking.reservationId }}
          </div>
          <div class="detail-item">
            <strong>ID Offre:</strong> {{ booking.offerId }}
          </div>
          <div class="detail-item">
            <strong>Date de r√©servation:</strong> {{ formatDate(booking.reservationDate) }}
          </div>
          <div class="detail-item" *ngIf="booking.createdAt">
            <strong>Cr√©√©e le:</strong> {{ formatDate(booking.createdAt) }}
          </div>
        </div>

        <!-- Actions par statut AVEC LOADING -->
        <div class="booking-actions">
          
          <!-- STATUT: PENDING -->
          <div *ngIf="booking.status === 'PENDING'" class="action-buttons">
            <!-- Bouton Confirmer avec loading -->
            <button class="btn btn-success btn-sm" 
                    (click)="confirmBooking(booking.reservationId!)"
                    [disabled]="isLoadingAction(booking.reservationId!, 'confirm')"
                    [class.loading]="isLoadingAction(booking.reservationId!, 'confirm')">
              
              <span *ngIf="!isLoadingAction(booking.reservationId!, 'confirm')">
                ‚úÖ Confirmer
              </span>
              <span *ngIf="isLoadingAction(booking.reservationId!, 'confirm')" class="btn-loading">
                <app-spinner size="small"></app-spinner>
                <span>Confirmation...</span>
              </span>
            </button>

            <!-- Bouton Annuler avec loading -->
            <button class="btn btn-warning btn-sm" 
                    (click)="openCancelModal(booking)"
                    [disabled]="isLoadingAction(booking.reservationId!, 'cancel')"
                    [class.loading]="isLoadingAction(booking.reservationId!, 'cancel')">
              
              <span *ngIf="!isLoadingAction(booking.reservationId!, 'cancel')">
                ‚ùå Annuler
              </span>
              <span *ngIf="isLoadingAction(booking.reservationId!, 'cancel')" class="btn-loading">
                <app-spinner size="small"></app-spinner>
                <span>Annulation...</span>
              </span>
            </button>
          </div>

          <!-- STATUT: CONFIRMED -->
          <div *ngIf="booking.status === 'CONFIRMED'" class="action-buttons">
            <!-- Bouton Annuler avec loading -->
            <button class="btn btn-warning btn-sm" 
                    (click)="openCancelModal(booking)"
                    [disabled]="isLoadingAction(booking.reservationId!, 'cancel')"
                    [class.loading]="isLoadingAction(booking.reservationId!, 'cancel')">
              
              <span *ngIf="!isLoadingAction(booking.reservationId!, 'cancel')">
                ‚ùå Annuler
              </span>
              <span *ngIf="isLoadingAction(booking.reservationId!, 'cancel')" class="btn-loading">
                <app-spinner size="small"></app-spinner>
                <span>Annulation...</span>
              </span>
            </button>
            <span class="action-info">‚úì R√©servation confirm√©e</span>
          </div>

          <!-- STATUT: CANCELLED -->
          <div *ngIf="booking.status === 'CANCELLED'" class="action-info">
            <span class="info-text">‚ùå R√©servation annul√©e</span>
            <!-- Bouton Supprimer avec loading -->
            <button class="btn btn-danger btn-sm" 
                    (click)="openDeleteModal(booking)"
                    [disabled]="isLoadingAction(booking.reservationId!, 'delete')"
                    [class.loading]="isLoadingAction(booking.reservationId!, 'delete')">
              
              <span *ngIf="!isLoadingAction(booking.reservationId!, 'delete')">
                üóëÔ∏è Supprimer
              </span>
              <span *ngIf="isLoadingAction(booking.reservationId!, 'delete')" class="btn-loading">
                <app-spinner size="small"></app-spinner>
                <span>Suppression...</span>
              </span>
            </button>
          </div>

          <!-- STATUT: COMPLETED -->
          <div *ngIf="booking.status === 'COMPLETED'" class="action-info">
            <span class="info-text">‚úì R√©servation termin√©e</span>
            <button class="btn btn-outline btn-sm" disabled>
              Termin√©
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

   <!-- Modal d'annulation -->
  <app-confirmation-modal
    [isVisible]="showCancelModal"
    [bookingStatus]="selectedBooking?.status || ''"
    [bookingDetails]="selectedBooking"
    [showReasonInput]="showCancelReason"
    [isConfirming]="isCancelling"
    (confirmed)="onCancelConfirmed($event)"
    (cancelled)="onCancelCancelled()">
  </app-confirmation-modal>

  <!-- Modal de suppression -->
  <app-delete-confirmation-modal
    [isVisible]="showDeleteModal"
    [bookingDetails]="bookingToDelete"
    [getOfferDetails]="deleteModalGetOfferDetails"
    (confirmed)="onDeleteConfirmed()"
    (cancelled)="onDeleteCancelled()">
  </app-delete-confirmation-modal>
</div>
