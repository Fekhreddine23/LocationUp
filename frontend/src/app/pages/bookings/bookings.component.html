 <!-- Ajouter le breadcrumb en haut -->
<app-breadcrumbs [items]="breadcrumbItems"></app-breadcrumbs>

<div class="bookings-container">
  <div class="bookings-header">
    <h1>Mes R√©servations</h1>
    <button class="btn btn-primary" (click)="createNewBooking()">
      + Nouvelle R√©servation
    </button>
  </div>

  <div class="identity-warning" *ngIf="identityWarningVisible">
    <div class="warning-icon">ü™™</div>
    <div class="warning-content">
      <h3>V√©rification d'identit√© requise</h3>
      <p>Confirmez vos r√©servations et vos paiements une fois vos documents valid√©s.</p>
      <small *ngIf="identityStatus?.updatedAt">
        Derni√®re mise √† jour : {{ identityStatus?.updatedAt | date:'dd/MM/yyyy HH:mm' }}
      </small>
      <small *ngIf="identityStatus?.reason">
        Motif Stripe : {{ identityStatus?.reason }}
      </small>
    </div>
    <a routerLink="/profile" fragment="identity" class="btn btn-outline">
      Faites v√©rifier vos documents ‚Üí
    </a>
  </div>

  <!-- Loading State -->
  <div *ngIf="isLoading && bookings.length === 0" class="loading-state">
    <app-spinner text="Chargement de vos r√©servations..."></app-spinner>
  </div>

  <!-- Error Message -->
  <div *ngIf="errorMessage" class="alert alert-error">
    ‚ùå {{ errorMessage }}
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading && bookings.length === 0" class="empty-state">
    <div class="empty-icon">üìã</div>
    <h3>Aucune r√©servation</h3>
    <p>Vous n'avez pas encore de r√©servation.</p>
    <button class="btn btn-primary" (click)="createNewBooking()">
      Cr√©er ma premi√®re r√©servation
    </button>
  </div>

  <!-- Bookings List -->
  <div *ngIf="!isLoading && bookings.length > 0" class="bookings-list">
    
    <!-- Filtres et statistiques -->
    <div class="bookings-filters">
      <div class="stats">
        <span class="stat">
          <strong>{{ bookings.length }}</strong> r√©servation(s)
        </span>
        <span class="stat">
          <span class="status-badge status-pending">{{ getCountByStatus('PENDING') }}</span> En attente
        </span>
        <span class="stat">
          <span class="status-badge status-confirmed">{{ getCountByStatus('CONFIRMED') }}</span> Confirm√©es
        </span>
        <span class="stat">
          <span class="status-badge status-cancelled">{{ getCountByStatus('CANCELLED') }}</span> Annul√©es
        </span>
      </div>
    </div>

    <!-- Loading pendant le rechargement -->
    <div *ngIf="isLoading && bookings.length > 0" class="loading-overlay">
      <app-spinner size="small" text="Mise √† jour..."></app-spinner>
    </div>

    <!-- Liste des r√©servations -->
    <div class="booking-cards">
      <div *ngFor="let booking of bookings" 
           class="booking-card"
           [class]="getStatusCardClass(booking.status)">
        
        <!-- En-t√™te de la carte -->
        <div class="booking-header">
          <div class="booking-info">
            <h3 class="booking-title">
              R√©servation #{{ booking.reservationId }}
            </h3>
            <span class="booking-date">
              Cr√©√©e le {{ formatDate(booking.reservationDate) }}
            </span>
          </div>

          <div class="booking-status">
            <span [class]="'status-badge ' + getStatusBadgeClass(booking.status)">
              {{ getStatusText(booking.status) }}
            </span>
            <span class="payment-badge" [ngClass]="getPaymentBadgeClass(booking.paymentStatus)">
              üí≥ {{ getPaymentStatusText(booking.paymentStatus) }}
            </span>
          </div>
        </div>

        <!-- D√©tails de l'offre (charg√©s dynamiquement) -->
        <div *ngIf="getOfferDetails(booking.offerId)" class="offer-details">
          <h4>{{ getOfferDetails(booking.offerId).description }}</h4>
          <div class="offer-meta">
            <span class="price">{{ getOfferDetails(booking.offerId).price | currency:'EUR' }}</span>
            <span class="pickup-date">
              üìÖ Disponible le {{ formatDate(getOfferDetails(booking.offerId).pickupDatetime) }}
            </span>
          </div>
        </div>

        <!-- D√©tails de la r√©servation -->
        <div class="booking-details">
          <div class="detail-item">
            <strong>ID R√©servation:</strong> {{ booking.reservationId }}
          </div>
          <div class="detail-item">
            <strong>ID Offre:</strong> {{ booking.offerId }}
          </div>
          <div class="detail-item">
            <strong>Date de r√©servation:</strong> {{ formatDate(booking.reservationDate) }}
          </div>
          <div class="detail-item" *ngIf="booking.createdAt">
            <strong>Cr√©√©e le:</strong> {{ formatDate(booking.createdAt) }}
          </div>
        </div>

        <!-- Actions par statut AVEC LOADING -->
        <div class="booking-actions">
          
          <!-- STATUT: PENDING -->
          <div *ngIf="booking.status === 'PENDING'" class="action-buttons">
            <!-- Bouton Confirmer avec loading -->
            <button class="btn btn-success btn-sm" 
                    (click)="confirmBooking(booking.reservationId!)"
                    [disabled]="!canPerformPaymentActions || isLoadingAction(booking.reservationId!, 'confirm')"
                    [title]="!canPerformPaymentActions ? 'Identit√© √† v√©rifier' : ''"
                    [class.loading]="isLoadingAction(booking.reservationId!, 'confirm')">
              
              <span *ngIf="!isLoadingAction(booking.reservationId!, 'confirm')">
                ‚úÖ Confirmer
              </span>
              <span *ngIf="isLoadingAction(booking.reservationId!, 'confirm')" class="btn-loading">
                <app-spinner size="small"></app-spinner>
                <span>Confirmation...</span>
              </span>
            </button>

            <!-- Bouton Annuler avec loading -->
            <button class="btn btn-warning btn-sm" 
                    (click)="openCancelModal(booking)"
                    [disabled]="isLoadingAction(booking.reservationId!, 'cancel')"
                    [class.loading]="isLoadingAction(booking.reservationId!, 'cancel')">
              
              <span *ngIf="!isLoadingAction(booking.reservationId!, 'cancel')">
                ‚ùå Annuler
              </span>
              <span *ngIf="isLoadingAction(booking.reservationId!, 'cancel')" class="btn-loading">
                <app-spinner size="small"></app-spinner>
                <span>Annulation...</span>
              </span>
            </button>
            <p class="identity-hint" *ngIf="!canPerformPaymentActions">
              V√©rifiez votre identit√© pour confirmer cette r√©servation.
            </p>
          </div>

          <!-- STATUT: CONFIRMED -->
          <div *ngIf="booking.status === 'CONFIRMED'" class="action-buttons">
            <!-- Bouton Annuler avec loading -->
            <button class="btn btn-warning btn-sm" 
                    (click)="openCancelModal(booking)"
                    [disabled]="isLoadingAction(booking.reservationId!, 'cancel')"
                    [class.loading]="isLoadingAction(booking.reservationId!, 'cancel')">
              
              <span *ngIf="!isLoadingAction(booking.reservationId!, 'cancel')">
                ‚ùå Annuler
              </span>
              <span *ngIf="isLoadingAction(booking.reservationId!, 'cancel')" class="btn-loading">
                <app-spinner size="small"></app-spinner>
                <span>Annulation...</span>
              </span>
            </button>
            <span class="action-info">‚úì R√©servation confirm√©e</span>
          </div>

          <!-- STATUT: CANCELLED -->
          <div *ngIf="booking.status === 'CANCELLED'" class="action-info">
            <span class="info-text">‚ùå R√©servation annul√©e</span>
            <!-- Bouton Supprimer avec loading -->
            <button class="btn btn-danger btn-sm" 
                    (click)="openDeleteModal(booking)"
                    [disabled]="isLoadingAction(booking.reservationId!, 'delete')"
                    [class.loading]="isLoadingAction(booking.reservationId!, 'delete')">
              
              <span *ngIf="!isLoadingAction(booking.reservationId!, 'delete')">
                üóëÔ∏è Supprimer
              </span>
              <span *ngIf="isLoadingAction(booking.reservationId!, 'delete')" class="btn-loading">
                <app-spinner size="small"></app-spinner>
                <span>Suppression...</span>
              </span>
            </button>
          </div>

          <!-- STATUT: COMPLETED -->
          <div *ngIf="booking.status === 'COMPLETED'" class="action-info">
            <span class="info-text">‚úì R√©servation termin√©e</span>
            <button class="btn btn-outline btn-sm" disabled>
              Termin√©
            </button>
          </div>
          <div class="timeline-actions">
            <button class="btn btn-outline btn-sm" (click)="toggleTimeline(booking)">
              {{ timelineVisibility[booking.reservationId!] ? 'Masquer la timeline' : 'Afficher la timeline' }}
            </button>
            <button class="btn btn-outline btn-sm" (click)="downloadReceipt(booking.reservationId!)">
              üìÑ Re√ßu PDF
            </button>
            <button class="btn btn-outline btn-sm"
                    *ngIf="booking.paymentStatus !== 'PAID' && booking.paymentStatus !== 'REFUNDED'"
                    (click)="syncPayment(booking)"
                    [disabled]="paymentSyncLoading[booking.reservationId!] || !canPerformPaymentActions"
                    [title]="!canPerformPaymentActions ? 'Identit√© √† v√©rifier' : ''">
              <ng-container *ngIf="!paymentSyncLoading[booking.reservationId!]">üîÑ V√©rifier le paiement</ng-container>
              <ng-container *ngIf="paymentSyncLoading[booking.reservationId!]">‚è≥ V√©rification...</ng-container>
            </button>
            <p class="identity-hint" *ngIf="!canPerformPaymentActions">
              Finalisez la v√©rification pour relancer un paiement.
            </p>
          </div>
        </div>

        <div class="booking-timeline" *ngIf="timelineVisibility[booking.reservationId!]">
          <div *ngIf="timelineLoading[booking.reservationId!]" class="timeline-loading">
            <app-spinner size="small" text="Chargement de la timeline..."></app-spinner>
          </div>
          <ng-container *ngIf="!timelineLoading[booking.reservationId!]">
            <div *ngIf="getTimelineEvents(booking) as timeline; else emptyTimeline">
              <div class="timeline-event" *ngFor="let event of timeline.events">
                <div [class]="'event-indicator ' + getTimelineStatusClass(event.status)"></div>
                <div class="event-content">
                  <div class="event-header">
                    <h4>{{ event.title }}</h4>
                    <span class="event-date">{{ formatDate(event.timestamp) }}</span>
                  </div>
                  <p>{{ event.description }}</p>
                </div>
              </div>
            </div>
            <ng-template #emptyTimeline>
              <p class="timeline-empty">Aucun √©v√©nement disponible pour cette r√©servation.</p>
            </ng-template>
          </ng-container>
        </div>
      </div>
    </div>
  </div>

   <!-- Modal d'annulation -->
  <app-confirmation-modal
    [isVisible]="showCancelModal"
    [bookingStatus]="selectedBooking?.status || ''"
    [bookingDetails]="selectedBooking"
    [showReasonInput]="showCancelReason"
    [isConfirming]="isCancelling"
    (confirmed)="onCancelConfirmed($event)"
    (cancelled)="onCancelCancelled()">
  </app-confirmation-modal>

  <!-- Modal de suppression -->
  <app-delete-confirmation-modal
    [isVisible]="showDeleteModal"
    [bookingDetails]="bookingToDelete"
    [getOfferDetails]="deleteModalGetOfferDetails"
    (confirmed)="onDeleteConfirmed()"
    (cancelled)="onDeleteCancelled()">
  </app-delete-confirmation-modal>
</div>
