<div class="offre-detail-page">
  <div class="page-nav">
    <button class="ghost-btn" type="button" (click)="goBack()">
      ‚Üê Retour aux offres
    </button>
    <span class="breadcrumb-hint">
      Catalogue / Offre #{{ offer?.offerId || '...' }}
    </span>
  </div>

  <ng-container *ngIf="isLoading; else detailContent">
    <div class="card-surface loading-state hero-skeleton">
      <div class="skeleton-line wide"></div>
      <div class="skeleton-line"></div>
      <div class="skeleton-line short"></div>
    </div>
    <div class="detail-grid">
      <div class="card-surface loading-state" *ngFor="let _ of [1,2,3]">
        <div class="skeleton-line wide"></div>
        <div class="skeleton-line"></div>
        <div class="skeleton-line short"></div>
      </div>
    </div>
  </ng-container>

  <ng-template #detailContent>
    <div *ngIf="errorMessage" class="alert alert-error" role="alert" aria-live="assertive">
      ‚ùå {{ errorMessage }}
    </div>

    <ng-container *ngIf="offer as currentOffer; else noOffer">
      <section class="detail-hero card-surface">
        <div class="hero-heading">
          <div class="title-stack">
            <p class="offer-id">Offre #{{ currentOffer.offerId }}</p>
            <h1>{{ currentOffer.description }}</h1>
            <div class="meta-chips">
              <span class="chip">
                üöó {{ getMobilityServiceLabel() }}
              </span>
              <span class="chip">
                üìç {{ getPickupLabel() }}
              </span>
              <span class="chip" [class.accent-success]="isOfferAvailable()" [class.accent-danger]="!isOfferAvailable()">
                {{ isOfferAvailable() ? 'Disponible' : 'Non disponible' }}
              </span>
            </div>
          </div>
          <div class="price-tile">
            <span class="amount">{{ currentOffer.price | currency:'EUR' }}</span>
            <span class="caption">prix total TTC</span>
            <button
              class="primary-btn"
              type="button"
              (click)="reserveOffer()"
              [disabled]="!isOfferAvailable()">
              {{ isOfferAvailable() ? 'R√©server maintenant' : 'Indisponible' }}
            </button>
            <button
              class="ghost-btn favorite-toggle"
              type="button"
              (click)="toggleFavorite()"
              [disabled]="favoriteLoading"
              [attr.aria-pressed]="isFavorite">
              {{ isFavorite ? '‚òÖ Dans mes favoris' : '‚òÜ Ajouter aux favoris' }}
            </button>
          </div>
        </div>
        <div class="hero-stats">
          <div class="hero-stat">
            <small>Date de retrait</small>
            <strong>{{ formatDate(currentOffer.pickupDatetime) }}</strong>
          </div>
          <div class="hero-stat">
            <small>Cr√©√©e le</small>
            <strong>{{ formatDate(currentOffer.createdAt) }}</strong>
          </div>
          <div class="hero-stat">
            <small>Derni√®re mise √† jour</small>
            <strong>{{ formatDate(currentOffer.updatedAt) }}</strong>
          </div>
        </div>
      </section>

      <div class="detail-grid">
        <section class="gallery card-surface" aria-label="Galerie photos">
          <div
            class="gallery-main"
            (touchstart)="onGalleryTouchStart($event)"
            (touchmove)="onGalleryTouchMove($event)"
            (touchend)="onGalleryTouchEnd()">
            <img [src]="selectedImage || galleryImages[0]" [alt]="currentOffer.description">
            <div class="gallery-controls" *ngIf="galleryImages.length > 1">
              <button type="button" class="control prev" (click)="goToPreviousImage()" aria-label="Image pr√©c√©dente">‚Äπ</button>
              <button type="button" class="control next" (click)="goToNextImage()" aria-label="Image suivante">‚Ä∫</button>
            </div>
          </div>
          <div class="gallery-thumbs" *ngIf="galleryImages.length > 1">
            <button
              type="button"
              class="thumb"
              *ngFor="let image of galleryImages"
              [class.active]="image === selectedImage"
              (click)="selectImage(image)">
              <img [src]="image" alt="vignette de l'offre">
            </button>
          </div>
        </section>

        <section class="card-surface info-column">
          <h2>Informations cl√©s</h2>
          <div class="info-grid">
            <div class="info-block">
              <span class="label">Point de retrait</span>
              <span class="value">{{ getPickupLabel() }}</span>
            </div>
            <div class="info-block">
              <span class="label">Point de retour</span>
              <span class="value">{{ getReturnLabel() }}</span>
            </div>
            <div class="info-block">
              <span class="label">Service</span>
              <span class="value">{{ getMobilityServiceLabel() }}</span>
            </div>
            <div class="info-block">
              <span class="label">Administrateur</span>
              <span class="value">{{ currentOffer.adminName || ('Admin #' + (currentOffer.adminId ?? 'N/A')) }}</span>
            </div>
          </div>

          <div class="equipment-section" *ngIf="equipmentList.length">
            <h3>√âquipements & services inclus</h3>
            <div class="equipment-tags">
              <span *ngFor="let item of equipmentList">{{ item }}</span>
            </div>
          </div>

          <div class="assurance-section" *ngIf="assuranceConditions.length">
            <h3>Assurance & conditions</h3>
            <ul>
              <li *ngFor="let condition of assuranceConditions">{{ condition }}</li>
            </ul>
          </div>

          <div class="addons-section" *ngIf="addonsList.length">
            <h3>Options & suppl√©ments</h3>
            <ul>
              <li *ngFor="let addon of addonsList">{{ addon }}</li>
            </ul>
          </div>
        </section>

        <section class="card-surface why-panel" *ngIf="highlightBadges.length">
          <h2>Pourquoi c'est pour vous</h2>
          <p class="muted">Synth√®se des points forts calcul√©s automatiquement.</p>
          <div class="highlight-badges">
            <span *ngFor="let badge of highlightBadges">
              {{ badge.icon }} {{ badge.label }}
            </span>
          </div>
        </section>

        <section class="card-surface support-callout">
          <div>
            <h3>Support & Assistance</h3>
            <p>Un conseiller peut vous aider √† finaliser la r√©servation ou g√©rer un paiement en attente.</p>
            <ul>
              <li>Assistance prioritaire par mail/SMS</li>
              <li>Suivi personnalis√© des paiements</li>
              <li>Conseils sur les assurances et options</li>
            </ul>
          </div>
          <button class="ghost-btn accent" type="button" (click)="contactSupport()">
            üìû Contacter le support
          </button>
        </section>

        <section class="card-surface booking-context" *ngIf="isAuthenticated; else bookingAuthFallback">
          <header>
            <div>
              <h3>Vos r√©servations associ√©es</h3>
              <p>Choisissez celle √† relancer si le paiement est en attente.</p>
            </div>
            <span class="status-pill" [class.accent-success]="userBookingsForOffer.length>0">
              {{ userBookingsForOffer.length }} r√©servation(s)
            </span>
          </header>

          <ng-container *ngIf="bookingsLoading; else bookingsList">
            <div class="booking-skeleton" *ngFor="let _ of [1,2]">
              <div class="skeleton-line wide"></div>
              <div class="skeleton-line"></div>
            </div>
          </ng-container>

          <ng-template #bookingsList>
            <div *ngIf="userBookingsForOffer.length; else noEligible">
              <label class="booking-option" *ngFor="let booking of userBookingsForOffer">
                <input
                  type="radio"
                  name="retryBooking"
                  [value]="booking.reservationId"
                  [checked]="booking === selectedBookingForRetry"
                  (change)="selectRetryBooking(booking)">
            <div class="booking-details">
              <div class="booking-main">
                <strong>R√©servation #{{ booking.reservationId }}</strong>
                <span>{{ formatDate((booking.reservationDate || booking.createdAt || '')) }}</span>
              </div>
              <div class="booking-meta">
                <span class="status-pill" [ngClass]="(booking.paymentStatus || booking.status || 'pending').toLowerCase()">
                  {{ getRetryStatusLabel(booking) }}
                </span>
                <span class="amount" *ngIf="booking.paymentReference">
                  Ref: {{ booking.paymentReference }}
                </span>
              </div>
            </div>
          </label>
            </div>
            <ng-template #noEligible>
              <p class="muted">Aucune r√©servation n√©cessitant une relance n‚Äôa √©t√© d√©tect√©e pour cette offre.</p>
            </ng-template>
          </ng-template>

          <div class="retry-actions" *ngIf="shouldShowRetryPayment()">
            <button class="primary-btn" type="button" (click)="retryPayment()" [disabled]="!selectedBookingForRetry">
              üîÅ Relancer le paiement
            </button>
          </div>
        </section>

        <ng-template #bookingAuthFallback>
          <section class="card-surface booking-context auth-fallback">
            <h3>Connectez-vous pour g√©rer vos paiements</h3>
            <p>Identifiez-vous pour retrouver vos r√©servations et relancer un paiement en attente.</p>
            <button class="primary-btn" type="button" (click)="redirectToLogin()">
              Se connecter
            </button>
          </section>
        </ng-template>

        <section class="card-surface action-panel">
          <h3>Actions rapides</h3>
          <div class="action-grid">
            <button type="button" class="secondary-btn" (click)="goBack()">
              ‚Üê Retour au catalogue
            </button>
            <button type="button" class="primary-btn" (click)="reserveOffer()" [disabled]="!isOfferAvailable()">
              R√©server cette offre
            </button>
            <button
              type="button"
              class="primary-btn accent"
              *ngIf="shouldShowRetryPayment()"
              (click)="retryPayment()">
              üîÅ Relancer le paiement
            </button>
          </div>
          <div *ngIf="!isOfferAvailable()" class="alert alert-warning">
            ‚ö†Ô∏è Cette offre n‚Äôest plus disponible √† la r√©servation (date d√©pass√©e).
          </div>
        </section>
      </div>
    </ng-container>

    <ng-template #noOffer>
      <div class="alert alert-error" role="alert">
        ‚ùå Aucun d√©tail d'offre √† afficher pour le moment.
      </div>
    </ng-template>
  </ng-template>
</div>
